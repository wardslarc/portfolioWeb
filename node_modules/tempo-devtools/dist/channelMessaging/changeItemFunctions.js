"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateCodebaseIds = exports.applyChangeItemToDocument = exports.getFullHtmlWithElement = exports.resetIntermediateClassesForSliderInstantUpdate = exports.TEMPORARY_STYLING_CLASS_NAME = exports.ADD_CLASS_INSTANT_UPDATE_QUEUE = exports.ADD_JSX_PREFIX = exports.DUPLICATE_PLACEHOLDER_PREFIX = exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID = void 0;
const jquery_1 = __importDefault(require("jquery"));
const identifierUtils_1 = require("./identifierUtils");
const changeLedgerTypes_1 = require("./changeLedgerTypes");
const constantsAndTypes_1 = require("./constantsAndTypes");
const cssRuleUtils_1 = require("./cssRuleUtils");
const sessionStorageUtils_1 = require("./sessionStorageUtils");
const tempoElement_1 = require("./tempoElement");
const uuid_1 = require("uuid");
// These constants match what tempo-api has
exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID = 'tempo-wrap-in-div-placeholder';
exports.DUPLICATE_PLACEHOLDER_PREFIX = 'tempo-duplicate-placeholder-';
exports.ADD_JSX_PREFIX = 'tempo-add-jsx-placeholder-';
// Stored in memory storage, used to keep track of some possible add class instant
// updates that need to be re-applied after a hot reload
// (e.g. when the additional) instant updates happened during flushing
exports.ADD_CLASS_INSTANT_UPDATE_QUEUE = 'ADD_CLASS_INSTANT_UPDATE_QUEUE';
exports.TEMPORARY_STYLING_CLASS_NAME = 'arb89-temp-styling';
const getTopLevelCodebaseIdForComponent = (componentId) => {
    let topLevelCodebaseId = null;
    let minNumberParents = Infinity;
    (0, jquery_1.default)(`.component-${componentId}`).each((index, element) => {
        if ((0, jquery_1.default)(element).parents().length < minNumberParents) {
            minNumberParents = (0, jquery_1.default)(element).parents().length;
            topLevelCodebaseId = (0, identifierUtils_1.getCodebaseIdFromNode)(element);
        }
    });
    return topLevelCodebaseId;
};
const makeid = (length) => {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const charactersLength = characters.length;
    let counter = 0;
    while (counter < length) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
        counter += 1;
    }
    return result;
};
let intermediateClassesForSliderInstantUpdate = {};
const resetIntermediateClassesForSliderInstantUpdate = () => {
    intermediateClassesForSliderInstantUpdate = {};
};
exports.resetIntermediateClassesForSliderInstantUpdate = resetIntermediateClassesForSliderInstantUpdate;
const sizeVariantToWrap = {
    sm: '@media (width >= 40rem)',
    md: '@media (width >= 48rem)',
    lg: '@media (width >= 64rem)',
    xl: '@media (width >= 80rem)',
    '2xl': '@media (width >= 96rem)',
};
const addClassCssRule = (className, rules, id, variant) => {
    let selector = className
        .replace(/\[/g, '\\[')
        .replace(/\]/g, '\\]')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)')
        .replace(/\./g, '\\.')
        .replace(/\%/g, '\\%')
        .replace(/\!/g, '\\!')
        .replace(/\//g, '\\/')
        .replace(/#/g, '\\#');
    let ruleToSet = rules;
    if (variant && variant !== 'default') {
        selector = `${variant}\\:${selector}`;
        if (variant === 'hover') {
            selector = `${selector}:hover`;
        }
        else if (sizeVariantToWrap[variant]) {
            ruleToSet = `${sizeVariantToWrap[variant]} { ${rules} }`;
        }
    }
    selector = `.${selector}`;
    try {
        addOrEditCSSRule(selector, ruleToSet, id);
    }
    catch (e) {
        console.log('Error adding class CSS rule', e);
    }
};
const addOrEditCSSRule = (selector, rules, id) => {
    var styleEl = document.createElement('style');
    if (id) {
        const existingElement = document.getElementById(id);
        if (existingElement) {
            existingElement.remove();
        }
        styleEl.id = id;
    }
    // Append <style> element to <head>
    document.head.appendChild(styleEl);
    var styleSheet = styleEl.sheet;
    if (styleSheet.insertRule) {
        // All browsers, except IE before version 9
        styleSheet.insertRule(selector + '{' + rules + '}', styleSheet.cssRules.length);
    }
    else if (styleSheet.addRule) {
        // IE before version 9
        styleSheet.addRule(selector, rules, styleSheet.rules.length);
    }
};
const getFullHtmlWithElement = (elementKeys) => {
    const validElementKeys = elementKeys.filter((elementKey) => elementKey !== null && elementKey !== undefined);
    if (!(validElementKeys === null || validElementKeys === void 0 ? void 0 : validElementKeys.length))
        return undefined;
    const elements = validElementKeys
        .map((elementKey) => (0, identifierUtils_1.getNodeForElementKey)(elementKey))
        .filter((element) => element !== null && element !== undefined);
    if (!elements.length || elements.length !== validElementKeys.length)
        return undefined;
    // Get the complete document HTML
    const fullDocumentHtml = document.documentElement.outerHTML;
    // Replace the body contents with just our specific element
    // This preserves the exact document structure, doctype, html attributes, and head contents
    return fullDocumentHtml.replace(/<body[^>]*>[\s\S]*<\/body>/i, `<body>${elements.map((element) => element === null || element === void 0 ? void 0 : element.outerHTML).join('')}</body>`);
};
exports.getFullHtmlWithElement = getFullHtmlWithElement;
const applyChangeItemToDocument = (parentPort, storyboardId, plainChangeItem) => {
    if (!plainChangeItem || !plainChangeItem.type) {
        return { sendNewNavTree: false, instantUpdateSuccessful: false };
    }
    const changeItem = (0, changeLedgerTypes_1.reconstructChangeLedgerClass)(plainChangeItem);
    let extraInstantUpdateData = {};
    let instantUpdateSuccessful = false;
    // The display: none rule is needed for a lot of instant updates, so create it if it doesn't exist
    if (!document.getElementById(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS)) {
        addClassCssRule(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS, 'display: none !important', identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
    }
    let sendNewNavTree = false;
    if (changeItem.type === changeLedgerTypes_1.ChangeType.ADD_JSX) {
        const castChangeItem = changeItem;
        const changeFields = castChangeItem.changeFields;
        const newAddedIds = [];
        if (changeFields.htmlForInstantUpdate) {
            const html = changeFields.htmlForInstantUpdate;
            // Some html provided has the full structure including html, body, header, etc so that it displays correctly in a preview
            // iframe. We just want to strip this and take the contents of the body.
            const elementToAdd = (0, jquery_1.default)(html.includes('<body')
                ? html.replace(/<body[^>]*>([\s\S]*)<\/body>/i, '$1')
                : html);
            elementToAdd.attr(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
            elementToAdd.attr(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
            elementToAdd.attr(identifierUtils_1.TEMPO_OUTLINE_UNTIL_REFESH, 'true');
            const ID_FOR_ELEMENT = `${exports.ADD_JSX_PREFIX}${(0, uuid_1.v4)()}`;
            elementToAdd.attr(identifierUtils_1.TEMPO_ELEMENT_ID, ID_FOR_ELEMENT);
            elementToAdd.addClass(ID_FOR_ELEMENT);
            newAddedIds.push(ID_FOR_ELEMENT);
            (0, jquery_1.default)(`.${changeFields.codebaseIdToAddTo}`).each((index, item) => {
                if (changeFields.afterCodebaseId) {
                    const afterElement = (0, jquery_1.default)(`.${changeFields.afterCodebaseId}`);
                    if (!(afterElement === null || afterElement === void 0 ? void 0 : afterElement.length)) {
                        return;
                    }
                    elementToAdd.insertAfter(afterElement.first());
                }
                else if (changeFields.beforeCodebaseId) {
                    const beforeElement = (0, jquery_1.default)(`.${changeFields.beforeCodebaseId}`);
                    if (!(beforeElement === null || beforeElement === void 0 ? void 0 : beforeElement.length)) {
                        return;
                    }
                    elementToAdd.insertBefore(beforeElement.first());
                }
                else {
                    (0, jquery_1.default)(item).append(elementToAdd);
                }
                sendNewNavTree = true;
                instantUpdateSuccessful = true;
            });
        }
        extraInstantUpdateData['newAddedIds'] = newAddedIds;
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.MOVE_JSX) {
        const castChangeItem = changeItem;
        // Find each element that matches the jsxCodebaseId
        const sourceElements = [];
        // See if direct matches work first
        if ((0, jquery_1.default)(`.${castChangeItem.changeFields.codebaseIdToMove}`).length > 0) {
            (0, jquery_1.default)(`.${castChangeItem.changeFields.codebaseIdToMove}`).each((index, element) => {
                sourceElements.push((0, jquery_1.default)(element));
            });
        }
        else {
            // Try to find it by the component ID
            let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.codebaseIdToMove || '');
            if (topLevelCodebaseId) {
                (0, jquery_1.default)(`.${topLevelCodebaseId}`).each((index, element) => {
                    sourceElements.push((0, jquery_1.default)(element));
                });
            }
        }
        // If the container is a component, drop into the codebaseId of the top-most child div
        let containerCodebaseId = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.codebaseIdToMoveTo || '') || castChangeItem.changeFields.codebaseIdToMoveTo;
        // For each source element, find the new matching parent element
        const newParentElements = [];
        sourceElements.forEach((element) => {
            let newParentElement = null;
            // For each parent, try to see if it either matches or contains the new parent
            let parentElement = element.parent();
            while (parentElement.length) {
                // If the parent directly matches, this is it
                if (parentElement.hasClass(containerCodebaseId)) {
                    newParentElement = parentElement;
                    break;
                }
                // Check children that match the codebase ID to drop into
                const matchingChildren = parentElement.find(`.${containerCodebaseId}`);
                if (matchingChildren.length) {
                    // TODO: What if this matches more than one?
                    newParentElement = matchingChildren.first();
                    break;
                }
                parentElement = parentElement.parent();
            }
            if (!newParentElement) {
                newParentElements.push(null);
                return;
            }
            newParentElements.push(newParentElement);
        });
        // For each child/parentElement pair, move the child to the new parent
        sourceElements.forEach((element, index) => {
            const newParentElement = newParentElements[index];
            if (!newParentElement.length) {
                console.log('Could not find new parent element for instant update');
                return;
            }
            sendNewNavTree = true;
            instantUpdateSuccessful = true;
            element.attr(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true');
            // If the parent hasn't changed, just move it, otherwise clone it and create a new one in the new spot
            let useClone = !newParentElement.is(element.parent());
            // So that nextjs hot reloading works, simply hide the element and clone it into the new spot
            let cloneElement;
            if (useClone) {
                cloneElement = element.clone();
                cloneElement.attr(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
                element.addClass(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                element.attr(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
            }
            if (castChangeItem.changeFields.afterCodebaseId) {
                const afterIdToUse = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.afterCodebaseId) || castChangeItem.changeFields.afterCodebaseId;
                const afterElement = newParentElement.children(`.${afterIdToUse}`);
                if (afterElement.length) {
                    if (useClone && cloneElement) {
                        cloneElement.insertAfter(afterElement.first());
                    }
                    else {
                        element.insertAfter(afterElement.first());
                    }
                    return;
                }
            }
            if (castChangeItem.changeFields.beforeCodebaseId) {
                const beforeIdToUse = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.beforeCodebaseId) || castChangeItem.changeFields.beforeCodebaseId;
                const beforeElement = newParentElement.children(`.${beforeIdToUse}`);
                if (beforeElement.length) {
                    if (useClone && cloneElement) {
                        cloneElement.insertBefore(beforeElement.first());
                    }
                    else {
                        element.insertBefore(beforeElement.first());
                    }
                    return;
                }
            }
            if (useClone && cloneElement) {
                cloneElement.appendTo(newParentElement);
            }
            else {
                element.appendTo(newParentElement);
            }
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.REMOVE_JSX) {
        const castChangeItem = changeItem;
        const parentToElementKeysRemoved = {};
        castChangeItem.changeFields.codebaseIdsToRemove.forEach((codebaseId) => {
            // See if direct matches work first
            let codebaseIdToRemove;
            if ((0, jquery_1.default)(`.${codebaseId}`).length > 0) {
                codebaseIdToRemove = codebaseId;
            }
            else {
                // Try to find it by the component ID
                let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(codebaseId || '');
                if (!topLevelCodebaseId) {
                    console.log('Could not find component element for instant update');
                    return false;
                }
                codebaseIdToRemove = topLevelCodebaseId;
            }
            // For each item that is removed, save the inner HTML in case it gets deleted and we want to undo
            (0, jquery_1.default)(`.${codebaseIdToRemove}`).each((index, item) => {
                const elementKeyRemoved = (0, identifierUtils_1.getElementKeyFromNode)(item);
                const parentElementKey = (0, identifierUtils_1.getElementKeyFromNode)(item.parentElement);
                if (elementKeyRemoved && parentElementKey) {
                    if (!parentToElementKeysRemoved[parentElementKey]) {
                        parentToElementKeysRemoved[parentElementKey] = [];
                    }
                    parentToElementKeysRemoved[parentElementKey].push({
                        outerHTML: item.outerHTML,
                        elementKeyRemoved,
                    });
                }
                item.classList.add(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                item.setAttribute(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
                sendNewNavTree = true;
                instantUpdateSuccessful = true;
            });
        });
        extraInstantUpdateData.parentToElementKeysRemoved =
            parentToElementKeysRemoved;
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.ADD_CLASS ||
        changeItem.type === changeLedgerTypes_1.ChangeType.STYLING) {
        let className, cssEquivalent, codebaseIdToAddClass, temporaryClass, codebaseClassName, modifiers;
        if (changeItem.type === changeLedgerTypes_1.ChangeType.ADD_CLASS) {
            const castChangeItem = changeItem;
            codebaseClassName = castChangeItem.changeFields.className;
            className = castChangeItem.changeFields.className;
            cssEquivalent = castChangeItem.changeFields.cssEquivalent;
            codebaseIdToAddClass = castChangeItem.changeFields.codebaseIdToAddClass;
            temporaryClass = castChangeItem.changeFields.temporaryOnly;
            modifiers = castChangeItem.changeFields.modifiers;
            if (temporaryClass) {
                className = exports.TEMPORARY_STYLING_CLASS_NAME;
            }
        }
        else {
            // As of March 6, 2024 we only support tailwind STYLING changes, so treat them as adding a class
            const castChangeItem = changeItem.changeFields;
            className = '';
            cssEquivalent = Object.keys(castChangeItem.stylingChanges)
                .map((key) => {
                if (castChangeItem.stylingChanges[key] === constantsAndTypes_1.DELETE_STYLE_CONSTANT) {
                    return `${(0, cssRuleUtils_1.camelToSnakeCase)(key)}: unset !important;`;
                }
                return `${(0, cssRuleUtils_1.camelToSnakeCase)(key)}: ${castChangeItem.stylingChanges[key]};`;
            })
                .join('');
            codebaseIdToAddClass = castChangeItem.codebaseId;
            modifiers = castChangeItem.modifiers;
        }
        const SAFE_CLASSNAME_REGEX = /[^A-Za-z0-9_-]/g;
        // Escape any custom classes
        let classToAdd = (className || '')
            .replace(SAFE_CLASSNAME_REGEX, '-') // Replace any non-alphanumeric characters with '-'
            .replace(/^\d/, '-$&'); // If the class starts with a digit, prepend with '-'
        // Instead of adding the class name, generate a new class and set the
        // css equivalent values inside it
        // This class will be deleted after a hot reload
        // Note - for temporary classes we want to explicitly use the same class
        if (cssEquivalent && !temporaryClass) {
            const msSinceJan1 = Date.now() - 1704067200000;
            classToAdd = `${identifierUtils_1.TEMPO_INSTANT_UPDATE_STYLING_PREFIX}${msSinceJan1}-${classToAdd}`;
        }
        if (classToAdd) {
            if (!temporaryClass) {
                // Clear the temporary class on this element if it has it
                (0, jquery_1.default)(`.${codebaseIdToAddClass}`).removeClass(exports.TEMPORARY_STYLING_CLASS_NAME);
            }
            if (cssEquivalent) {
                if (modifiers && modifiers.length > 0) {
                    const CSS_PSEUDO_MODIFIERS = [
                        'hover',
                        'required',
                        'focus',
                        'active',
                        'invalid',
                        'disabled',
                    ];
                    const pseudoModifiers = modifiers.filter((modifier) => CSS_PSEUDO_MODIFIERS.includes(modifier));
                    const pseudoModifiersSuffix = pseudoModifiers.join(':');
                    if (pseudoModifiers.length > 0) {
                        const modifierClass = `${classToAdd}:${pseudoModifiersSuffix}`;
                        addClassCssRule(modifierClass, cssEquivalent, modifierClass);
                    }
                    else {
                        addClassCssRule(classToAdd, cssEquivalent, classToAdd);
                    }
                    const forceClasses = modifiers
                        .map((modifier) => `.tempo-force-${modifier}`)
                        .join('');
                    const instantUpdateForForceClass = `${classToAdd}${forceClasses}`;
                    addClassCssRule(instantUpdateForForceClass, cssEquivalent, instantUpdateForForceClass);
                }
                else {
                    addClassCssRule(classToAdd, cssEquivalent, classToAdd);
                }
            }
            const currentAddClassValues = (0, sessionStorageUtils_1.getMemoryStorageItem)(exports.ADD_CLASS_INSTANT_UPDATE_QUEUE) || [];
            // See if direct matches work first
            if ((0, jquery_1.default)(`.${codebaseIdToAddClass}`).length > 0) {
                (0, jquery_1.default)(`.${codebaseIdToAddClass}`).addClass(classToAdd);
                instantUpdateSuccessful = true;
                currentAddClassValues.push({
                    codebaseId: codebaseIdToAddClass,
                    className: classToAdd,
                });
            }
            else {
                // Try to find it by the component ID
                let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(codebaseIdToAddClass || '');
                if (topLevelCodebaseId && (0, jquery_1.default)(`.${topLevelCodebaseId}`).length > 0) {
                    instantUpdateSuccessful = true;
                    (0, jquery_1.default)(`.${topLevelCodebaseId}`).addClass(classToAdd);
                    currentAddClassValues.push({
                        codebaseId: topLevelCodebaseId,
                        className: classToAdd,
                    });
                }
            }
            (0, sessionStorageUtils_1.setMemoryStorageItem)(exports.ADD_CLASS_INSTANT_UPDATE_QUEUE, currentAddClassValues);
            extraInstantUpdateData.addedClass = classToAdd;
            extraInstantUpdateData.codebaseAddedClass = codebaseClassName;
        }
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.REMOVE_CLASS) {
        const removeClassChangeFields = changeItem.changeFields;
        // See if direct matches work first
        if ((0, jquery_1.default)(`.${removeClassChangeFields.codebaseIdToRemoveClass}`).length > 0) {
            (0, jquery_1.default)(`.${removeClassChangeFields.codebaseIdToRemoveClass}`).removeClass(removeClassChangeFields.className);
            instantUpdateSuccessful = true;
        }
        else {
            // Try to find it by the component ID
            let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(removeClassChangeFields.codebaseIdToRemoveClass || '');
            if (topLevelCodebaseId && (0, jquery_1.default)(`.${topLevelCodebaseId}`).length > 0) {
                instantUpdateSuccessful = true;
                (0, jquery_1.default)(`.${topLevelCodebaseId}`).removeClass(removeClassChangeFields.className);
            }
        }
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.WRAP_DIV) {
        const changeFields = changeItem.changeFields;
        const codebaseIdsToWrap = changeFields.codebaseIdsToWrap;
        const firstCodebaseId = codebaseIdsToWrap[0];
        // We assume the other codebase IDs are siblings of this codebase ID, so we
        // find each instance of the first one and include the other items that match in it
        // If the other items aren't all found, we do not wrap and let hot reload handle it
        (0, jquery_1.default)(`.${firstCodebaseId}`).each((index, item) => {
            const otherCodebaseIds = codebaseIdsToWrap.slice(1);
            // For each codebase ID in otherCodebaseIds, retrieve the element that is a sibling of item
            const siblings = (0, jquery_1.default)(item).siblings();
            const allItemsToAddToNewDiv = [item];
            let earliestItem = item;
            let earliestIndex = (0, jquery_1.default)(item).index();
            otherCodebaseIds.forEach((codebaseId) => {
                const foundSibling = siblings.filter(`.${codebaseId}`).get(0);
                if (foundSibling) {
                    allItemsToAddToNewDiv.push(foundSibling);
                    const index = (0, jquery_1.default)(foundSibling).index();
                    if (index < earliestIndex) {
                        earliestItem = foundSibling;
                        earliestIndex = index;
                    }
                }
            });
            // TODO: What to do if they all can't be found?
            if (allItemsToAddToNewDiv.length !== codebaseIdsToWrap.length) {
                // For now, just add the ones that were found
            }
            // Create a div with a clone of the item, while hiding the item
            // When the hot reload happens the clone gets deleted and the item is shown again
            const newDiv = document.createElement('div');
            newDiv.className = exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID;
            newDiv.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
            newDiv.setAttribute('tempoelementid', exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID);
            newDiv.setAttribute('data-testid', exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID);
            newDiv.setAttribute(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
            allItemsToAddToNewDiv.forEach((elem) => {
                newDiv.appendChild(elem.cloneNode(true));
                elem.classList.add(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                elem.setAttribute(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
            });
            // Insert the new div right before the first item
            earliestItem.insertAdjacentElement('beforebegin', newDiv);
            sendNewNavTree = true;
            instantUpdateSuccessful = true;
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.DUPLICATE) {
        const changeFileds = changeItem.changeFields;
        const codebaseIdsToDuplicate = changeFileds.codebaseIdsToDuplicate;
        codebaseIdsToDuplicate.forEach((codebaseIdToDuplicate) => {
            (0, jquery_1.default)(`.${codebaseIdToDuplicate}`).each((index, item) => {
                const clonedNode = item.cloneNode(true);
                clonedNode.setAttribute(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
                clonedNode.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
                // Set up all the correct duplicated codebase IDs
                clonedNode.setAttribute('tempoelementid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseIdToDuplicate}`);
                clonedNode.setAttribute('data-testid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseIdToDuplicate}`);
                clonedNode.classList.add(exports.DUPLICATE_PLACEHOLDER_PREFIX + codebaseIdToDuplicate);
                clonedNode.classList.remove(codebaseIdToDuplicate);
                let children = Array.from(clonedNode.children);
                while (children.length) {
                    const child = children.pop();
                    if (!child) {
                        continue;
                    }
                    const codebaseId = child.getAttribute('tempoelementid') ||
                        child.getAttribute('data-testid');
                    if (!codebaseId) {
                        continue;
                    }
                    child.setAttribute('tempoelementid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseId}`);
                    child.setAttribute('data-testid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseId}`);
                    child.classList.remove(codebaseId);
                    child.classList.add(exports.DUPLICATE_PLACEHOLDER_PREFIX + codebaseId);
                    child.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true');
                    children.push(...Array.from(child.children));
                }
                // Add the clones node right after the found node
                item.insertAdjacentElement('afterend', clonedNode);
                sendNewNavTree = true;
                instantUpdateSuccessful = true;
            });
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.CHANGE_TAG) {
        const changeFields = changeItem.changeFields;
        (0, jquery_1.default)(`.${changeFields.codebaseIdToChange}`).each((index, item) => {
            const $newElement = (0, jquery_1.default)('<' + changeFields.newTagName + '></' + changeFields.newTagName + '>');
            $newElement.attr(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
            $newElement.attr(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
            const $item = (0, jquery_1.default)(item);
            // Copy all attributes from the original element to the new element
            jquery_1.default.each($item[0].attributes, function () {
                $newElement.attr(this.name, this.value);
            });
            $item.contents().clone(true, true).appendTo($newElement);
            // Add right before the cloned item so the unique path stays the same
            $item.before($newElement);
            // Hide the original item
            $item.addClass(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
            $item.attr(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
            sendNewNavTree = true;
            instantUpdateSuccessful = true;
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.UNDO) {
        const { sendNewNavTree: _sendNewNavTree, instantUpdateSuccessful: _instantUpdateSuccessful, } = applyUndoChangeItemToDocument(parentPort, changeItem);
        sendNewNavTree = _sendNewNavTree;
        instantUpdateSuccessful = _instantUpdateSuccessful;
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.REDO) {
        const changeFields = changeItem.changeFields;
        const changeToRedo = changeFields.changeToRedo;
        if (changeLedgerTypes_1.CHANGE_TYPES_WITH_INSTANT_UNDO.includes(changeToRedo.type)) {
            const { sendNewNavTree: _sendNewNavTree, instantUpdateSuccessful: _instantUpdateSuccessful, } = (0, exports.applyChangeItemToDocument)(parentPort, storyboardId, changeToRedo);
            sendNewNavTree = _sendNewNavTree;
            instantUpdateSuccessful = _instantUpdateSuccessful;
            if (changeToRedo.prevIdToNewIdMap) {
                const sendNewFromUpdate = (0, exports.updateCodebaseIds)(parentPort, changeToRedo.prevIdToNewIdMap, true);
                sendNewNavTree = sendNewFromUpdate || sendNewNavTree;
            }
        }
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.UPDATE_CLASSES) {
        const { codebaseIdToUpdateClass, newClasses, oldClasses, involvedClasses, isInstantChangeOnly, } = changeItem.changeFields;
        // TODO(nhanthai): Should handle this better instead of just remove and add
        for (const oldClass of oldClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).removeClass(oldClass);
        }
        (intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] || []).forEach((className) => {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).removeClass(className);
        });
        for (const newClass of newClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).addClass(newClass);
        }
        for (const involvedClass of involvedClasses) {
            addClassCssRule(involvedClass.tailwind, involvedClass.css, undefined, involvedClass.variant);
        }
        if (isInstantChangeOnly) {
            intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] = [];
            for (const involvedClass of involvedClasses) {
                const classToSet = involvedClass.variant
                    ? `${involvedClass.variant}:${involvedClass.tailwind}`
                    : involvedClass.tailwind;
                intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass].push(classToSet);
            }
        }
        else {
            intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] = [];
        }
    }
    // Immediately set the new selected element keys to prevent any delay in the outlines updating
    let elementKeyToSelectAfterInstantUpdate = changeItem.getElementKeyToSelectAfterInstantUpdate();
    let elementKeysToMultiselectAfterInstantUpdate = changeItem.getElementKeysToMultiselectAfterInstantUpdate();
    if (changeItem.type === changeLedgerTypes_1.ChangeType.UNDO) {
        elementKeyToSelectAfterInstantUpdate = changeItem.changeFields.changeToUndo.getElementKeyToSelectAfterUndoInstantUpdate();
        elementKeysToMultiselectAfterInstantUpdate = changeItem.changeFields.changeToUndo.getElementKeysToMultiselectAfterUndoInstantUpdate();
    }
    if (elementKeyToSelectAfterInstantUpdate !== undefined) {
        (0, sessionStorageUtils_1.setMemoryStorageItem)(sessionStorageUtils_1.SELECTED_ELEMENT_KEY, elementKeyToSelectAfterInstantUpdate);
        parentPort.postMessage({
            id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.SELECTED_ELEMENT_KEY,
            elementKey: elementKeyToSelectAfterInstantUpdate,
            outerHTML: (0, exports.getFullHtmlWithElement)([elementKeyToSelectAfterInstantUpdate]),
        });
    }
    if (elementKeysToMultiselectAfterInstantUpdate !== undefined) {
        (0, sessionStorageUtils_1.setMemoryStorageItem)(sessionStorageUtils_1.MULTI_SELECTED_ELEMENT_KEYS, elementKeysToMultiselectAfterInstantUpdate);
        parentPort.postMessage({
            id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.MULTI_SELECTED_ELEMENT_KEYS,
            elementKeys: elementKeysToMultiselectAfterInstantUpdate,
            outerHTMLs: (0, exports.getFullHtmlWithElement)(elementKeysToMultiselectAfterInstantUpdate || []),
        });
    }
    if (instantUpdateSuccessful) {
        // Delete any elements that need to be deleted after instant updates
        (0, jquery_1.default)(`*[${identifierUtils_1.TEMPO_DELETE_AFTER_INSTANT_UPDATE}=true]`).remove();
    }
    parentPort.postMessage({
        id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.INSTANT_UPDATE_DONE,
        changeItem: plainChangeItem,
        instantUpdateData: extraInstantUpdateData,
        instantUpdateSuccessful,
    });
    return { sendNewNavTree, instantUpdateSuccessful };
};
exports.applyChangeItemToDocument = applyChangeItemToDocument;
const applyUndoChangeItemToDocument = (parentPort, changeItem) => {
    const changeFields = changeItem.changeFields;
    const changeToUndo = changeFields.changeToUndo;
    if (!changeLedgerTypes_1.CHANGE_TYPES_WITH_INSTANT_UNDO.includes(changeToUndo.type)) {
        return { sendNewNavTree: false, instantUpdateSuccessful: false };
    }
    let sendNewNavTree = false;
    let instantUpdateSuccessful = false;
    // API has completed and the IDs have been updated, reverse this change
    if (changeToUndo.prevIdToNewIdMap) {
        const undoCodebaseIdChanges = {};
        Object.keys(changeToUndo.prevIdToNewIdMap).forEach((prevId) => {
            const newId = changeToUndo.prevIdToNewIdMap[prevId];
            undoCodebaseIdChanges[newId] = prevId;
        });
        // If undoing do not update the codebase IDs backwards if there are codebase IDs to set after
        // the undo instant update is done
        const selectedElementSpecifiedAfterUndo = changeToUndo.getElementKeyToSelectAfterUndoInstantUpdate() !== undefined;
        sendNewNavTree = (0, exports.updateCodebaseIds)(parentPort, undoCodebaseIdChanges, !selectedElementSpecifiedAfterUndo);
    }
    // Then undo the actual change
    if (changeToUndo.type === changeLedgerTypes_1.ChangeType.REMOVE_JSX) {
        // Re-add the removed JSX
        const innerChangeFields = changeToUndo.changeFields;
        const codebaseIdsToReadd = innerChangeFields.codebaseIdsToRemove;
        // If it has been flushed, re-create the html elements from the saved inner HTML
        if (changeFields.matchingActivityFlushed) {
            const instantUpdateData = changeToUndo.getInstantUpdateData();
            const parentToElementKeysRemoved = instantUpdateData.parentToElementKeysRemoved || {};
            Object.entries(parentToElementKeysRemoved).forEach(([parentElementKey, itemsRemoved]) => {
                // Sort the removed entries in order of unique path
                const sortedItemsRemoved = Object.values(itemsRemoved).sort((a, b) => {
                    const aElementKey = tempoElement_1.TempoElement.fromKey(a.elementKeyRemoved);
                    const bElementKey = tempoElement_1.TempoElement.fromKey(b.elementKeyRemoved);
                    return aElementKey.uniquePath.localeCompare(bElementKey.uniquePath);
                });
                // Find the parent element
                const parentElement = (0, identifierUtils_1.getNodeForElementKey)(parentElementKey);
                if (parentElement) {
                    // Add the removed elements back in order
                    sortedItemsRemoved.forEach((item) => {
                        const { elementKeyRemoved, outerHTML } = item;
                        const element = tempoElement_1.TempoElement.fromKey(elementKeyRemoved);
                        const indexInParent = Number(element.uniquePath.split('-').pop());
                        const newElementFromHtml = (0, jquery_1.default)(outerHTML).get(0);
                        // Add to the parent in the index
                        if (newElementFromHtml) {
                            newElementFromHtml.setAttribute(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
                            newElementFromHtml.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true');
                            parentElement.insertBefore(newElementFromHtml, parentElement.children[indexInParent] || null);
                            instantUpdateSuccessful = true;
                            sendNewNavTree = true;
                        }
                    });
                }
            });
        }
        else {
            // Not flushed yet so can just re-add
            codebaseIdsToReadd.forEach((codebaseIdToReadd) => {
                (0, jquery_1.default)(`.${codebaseIdToReadd}`).each((index, item) => {
                    item.classList.remove(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                    item.removeAttribute(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH);
                    sendNewNavTree = true;
                    instantUpdateSuccessful = true;
                });
            });
        }
    }
    else if (changeToUndo.type === changeLedgerTypes_1.ChangeType.ADD_CLASS ||
        changeToUndo.type === changeLedgerTypes_1.ChangeType.STYLING) {
        const instantUpdateData = changeToUndo.getInstantUpdateData();
        const innerChangeFields = changeToUndo.changeFields;
        const addedClass = instantUpdateData === null || instantUpdateData === void 0 ? void 0 : instantUpdateData.addedClass;
        if (addedClass) {
            (0, jquery_1.default)(`.${innerChangeFields.codebaseIdToAddClass}`).each((index, item) => {
                if ((0, jquery_1.default)(item).hasClass(addedClass)) {
                    (0, jquery_1.default)(item).removeClass(addedClass);
                    instantUpdateSuccessful = true;
                }
            });
        }
        const codebaseAddedClass = instantUpdateData === null || instantUpdateData === void 0 ? void 0 : instantUpdateData.codebaseAddedClass;
        if (codebaseAddedClass) {
            (0, jquery_1.default)(`.${innerChangeFields.codebaseIdToAddClass}`).each((index, item) => {
                if ((0, jquery_1.default)(item).hasClass(codebaseAddedClass)) {
                    (0, jquery_1.default)(item).removeClass(codebaseAddedClass);
                    instantUpdateSuccessful = true;
                }
            });
        }
    }
    else if (changeToUndo.type === changeLedgerTypes_1.ChangeType.UPDATE_CLASSES) {
        const { codebaseIdToUpdateClass, newClasses, oldClasses } = changeToUndo.changeFields;
        // TODO(nhanthai): Should handle this better instead of just remove and add
        for (const newClass of newClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).removeClass(newClass);
        }
        for (const oldClass of oldClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).addClass(oldClass);
        }
        intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] = [];
    }
    else if (changeToUndo.type === changeLedgerTypes_1.ChangeType.ADD_JSX) {
        const instantUpdateData = changeToUndo.getInstantUpdateData();
        const addedIds = instantUpdateData === null || instantUpdateData === void 0 ? void 0 : instantUpdateData.addedIds;
        addedIds === null || addedIds === void 0 ? void 0 : addedIds.forEach((addedId) => {
            (0, jquery_1.default)(`.${addedId}`).remove();
            instantUpdateSuccessful = true;
        });
        sendNewNavTree = true;
    }
    return { sendNewNavTree, instantUpdateSuccessful };
};
/**
 * After a change is processed on the backend, we need to update the codebase ids in the document.
 */
const updateCodebaseIds = (parentPort, prevIdToNewIdMap, updateElementKeys) => {
    // Update codebase ids in the document
    const changes = [];
    Object.entries(prevIdToNewIdMap).forEach(([prevCodebaseId, newCodebaseId]) => {
        (0, jquery_1.default)(`.${prevCodebaseId}`).each((index, item) => {
            changes.push({
                item,
                prevCodebaseId,
                newCodebaseId,
            });
        });
    });
    // Codebase Ids can swap, so we have to apply the changes after looking all elements up
    changes.forEach((change) => {
        const $item = (0, jquery_1.default)(change.item);
        const newClass = ($item.attr('class') || '').replace(new RegExp(`${change.prevCodebaseId}`, 'g'), change.newCodebaseId);
        $item.attr('class', newClass);
        change.item.setAttribute('tempoelementid', change.newCodebaseId);
        change.item.setAttribute('data-testid', change.newCodebaseId);
    });
    if (!updateElementKeys) {
        return Boolean(changes.length);
    }
    const keysToCheck = [
        {
            key: sessionStorageUtils_1.SELECTED_ELEMENT_KEY,
            messageId: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.SELECTED_ELEMENT_KEY,
        },
        {
            key: sessionStorageUtils_1.HOVERED_ELEMENT_KEY,
            messageId: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.HOVERED_ELEMENT_KEY,
        },
    ];
    keysToCheck.forEach(({ key, messageId }) => {
        const elementKey = (0, sessionStorageUtils_1.getMemoryStorageItem)(key);
        const tempoElement = tempoElement_1.TempoElement.fromKey(elementKey);
        if (prevIdToNewIdMap[tempoElement.codebaseId]) {
            const newElement = new tempoElement_1.TempoElement(prevIdToNewIdMap[tempoElement.codebaseId], tempoElement.storyboardId, tempoElement.uniquePath);
            (0, sessionStorageUtils_1.setMemoryStorageItem)(key, newElement.getKey());
            parentPort.postMessage({
                id: messageId,
                elementKey: newElement.getKey(),
                outerHTML: (0, exports.getFullHtmlWithElement)([newElement.getKey()]),
            });
        }
    });
    // Also update the multiselected element keys
    const multiselectedElementKeys = (0, sessionStorageUtils_1.getMemoryStorageItem)(sessionStorageUtils_1.MULTI_SELECTED_ELEMENT_KEYS);
    if (multiselectedElementKeys === null || multiselectedElementKeys === void 0 ? void 0 : multiselectedElementKeys.length) {
        const newMultiselectedElementKeys = [];
        multiselectedElementKeys.forEach((elementKey) => {
            const tempoElement = tempoElement_1.TempoElement.fromKey(elementKey);
            if (prevIdToNewIdMap[tempoElement.codebaseId]) {
                const newElement = new tempoElement_1.TempoElement(prevIdToNewIdMap[tempoElement.codebaseId], tempoElement.storyboardId, tempoElement.uniquePath);
                newMultiselectedElementKeys.push(newElement.getKey());
            }
            else {
                newMultiselectedElementKeys.push(elementKey);
            }
        });
        (0, sessionStorageUtils_1.setMemoryStorageItem)(sessionStorageUtils_1.MULTI_SELECTED_ELEMENT_KEYS, newMultiselectedElementKeys);
        parentPort.postMessage({
            id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.MULTI_SELECTED_ELEMENT_KEYS,
            elementKeys: newMultiselectedElementKeys,
            outerHTMLs: (0, exports.getFullHtmlWithElement)(newMultiselectedElementKeys),
        });
    }
    return Boolean(changes.length);
};
exports.updateCodebaseIds = updateCodebaseIds;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlSXRlbUZ1bmN0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jaGFubmVsTWVzc2FnaW5nL2NoYW5nZUl0ZW1GdW5jdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsb0RBQXVCO0FBQ3ZCLHVEQVkyQjtBQUMzQiwyREFvQjZCO0FBQzdCLDJEQUc2QjtBQUM3QixpREFBa0Q7QUFDbEQsK0RBTStCO0FBQy9CLGlEQUE4QztBQUM5QywrQkFBb0M7QUFFcEMsMkNBQTJDO0FBQzlCLFFBQUEsbUNBQW1DLEdBQzlDLCtCQUErQixDQUFDO0FBQ3JCLFFBQUEsNEJBQTRCLEdBQUcsOEJBQThCLENBQUM7QUFDOUQsUUFBQSxjQUFjLEdBQUcsNEJBQTRCLENBQUM7QUFFM0Qsa0ZBQWtGO0FBQ2xGLHdEQUF3RDtBQUN4RCxzRUFBc0U7QUFDekQsUUFBQSw4QkFBOEIsR0FBRyxnQ0FBZ0MsQ0FBQztBQUVsRSxRQUFBLDRCQUE0QixHQUFHLG9CQUFvQixDQUFDO0FBRWpFLE1BQU0saUNBQWlDLEdBQUcsQ0FBQyxXQUFtQixFQUFVLEVBQUU7SUFDeEUsSUFBSSxrQkFBa0IsR0FBUSxJQUFJLENBQUM7SUFDbkMsSUFBSSxnQkFBZ0IsR0FBRyxRQUFRLENBQUM7SUFDaEMsSUFBQSxnQkFBQyxFQUFDLGNBQWMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFVLEVBQUUsT0FBWSxFQUFFLEVBQUU7UUFDL0QsSUFBSSxJQUFBLGdCQUFDLEVBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxHQUFHLGdCQUFnQixFQUFFO1lBQ2xELGdCQUFnQixHQUFHLElBQUEsZ0JBQUMsRUFBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUM7WUFDL0Msa0JBQWtCLEdBQUcsSUFBQSx1Q0FBcUIsRUFBQyxPQUFPLENBQUMsQ0FBQztTQUNyRDtJQUNILENBQUMs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QUFJLDJCQUFZLENBQ2pDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsRUFDekMsWUFBWSxDQUFDLFlBQVksRUFDekIsWUFBWSxDQUFDLFVBQVUsQ0FDeEIsQ0FBQztnQkFDRiwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7YUFDdkQ7aUJBQU07Z0JBQ0wsMkJBQTJCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzlDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLDBDQUFvQixFQUNsQixpREFBMkIsRUFDM0IsMkJBQTJCLENBQzVCLENBQUM7UUFDRixVQUFVLENBQUMsV0FBVyxDQUFDO1lBQ3JCLEVBQUUsRUFBRSw0Q0FBd0IsQ0FBQywyQkFBMkI7WUFDeEQsV0FBVyxFQUFFLDJCQUEyQjtZQUN4QyxVQUFVLEVBQUUsSUFBQSw4QkFBc0IsRUFBQywyQkFBMkIsQ0FBQztTQUNoRSxDQUFDLENBQUM7S0FDSjtJQUVELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqQyxDQUFDLENBQUM7QUFuR1csUUFBQSxpQkFBaUIscUJBbUc1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAkIGZyb20gJ2pxdWVyeSc7XG5pbXBvcnQge1xuICBURU1QT19ERUxFVEVfQUZURVJfUkVGUkVTSCxcbiAgVEVNUE9fRE9fTk9UX1NIT1dfSU5fTkFWX1VOVElMX1JFRlJFU0gsXG4gIFRFTVBPX0lOU1RBTlRfVVBEQVRFLFxuICBURU1QT19JTlNUQU5UX1VQREFURV9TVFlMSU5HX1BSRUZJWCxcbiAgVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MsXG4gIGdldENvZGViYXNlSWRGcm9tTm9kZSxcbiAgZ2V0RWxlbWVudEtleUZyb21Ob2RlLFxuICBURU1QT19FTEVNRU5UX0lELFxuICBURU1QT19ERUxFVEVfQUZURVJfSU5TVEFOVF9VUERBVEUsXG4gIFRFTVBPX09VVExJTkVfVU5USUxfUkVGRVNILFxuICBnZXROb2RlRm9yRWxlbWVudEtleSxcbn0gZnJvbSAnLi9pZGVudGlmaWVyVXRpbHMnO1xuaW1wb3J0IHtcbiAgQWRkQ2xhc3NDaGFuZ2UsXG4gIEFkZENsYXNzQ2hhbmdlRmllbGRzLFxuICBBZGRKc3hDaGFuZ2UsXG4gIEFueUNoYW5nZUxlZGdlckl0ZW0sXG4gIENIQU5HRV9UWVBFU19XSVRIX0lOU1RBTlRfVU5ETyxcbiAgQ2hhbmdlVGFnQ2hhbmdlRmllbGRzLFxuICBDaGFuZ2VUeXBlLFxuICBEdXBsaWNhdGVDaGFuZ2VGaWVsZHMsXG4gIE1vdmVKc3hDaGFuZ2UsXG4gIFJlZG9DaGFuZ2VGaWVsZHMsXG4gIFJlbW92ZUNsYXNzQ2hhbmdlRmllbGRzLFxuICBSZW1vdmVKc3hDaGFuZ2UsXG4gIFJlbW92ZUpzeENoYW5nZUZpZWxkcyxcbiAgU3R5bGluZ0NoYW5nZUZpZWxkcyxcbiAgVW5kb0NoYW5nZSxcbiAgVW5kb0NoYW5nZUZpZWxkcyxcbiAgVXBkYXRlQ2xhc3Nlc0NoYW5nZUZpZWxkcyxcbiAgV3JhcERpdkNoYW5nZUZpZWxkcyxcbiAgcmVjb25zdHJ1Y3RDaGFuZ2VMZWRnZXJDbGFzcyxcbn0gZnJvbSAnLi9jaGFuZ2VMZWRnZXJUeXBlcyc7XG5pbXBvcnQge1xuICBERUxFVEVfU1RZTEVfQ09OU1RBTlQsXG4gIEZJWEVEX0lGUkFNRV9NRVNTQUdFX0lEUyxcbn0gZnJvbSAnLi9jb25zdGFudHNBbmRUeXBlcyc7XG5pbXBvcnQgeyBjYW1lbFRvU25ha2VDYXNlIH0gZnJvbSAnLi9jc3NSdWxlVXRpbHMnO1xuaW1wb3J0IHtcbiAgSE9WRVJFRF9FTEVNRU5UX0tFWSxcbiAgTVVMVElfU0VMRUNURURfRUxFTUVOVF9LRVlTLFxuICBTRUxFQ1RFRF9FTEVNRU5UX0tFWSxcbiAgZ2V0TWVtb3J5U3RvcmFnZUl0ZW0sXG4gIHNldE1lbW9yeVN0b3JhZ2VJdGVtLFxufSBmcm9tICcuL3Nlc3Npb25TdG9yYWdlVXRpbHMnO1xuaW1wb3J0IHsgVGVtcG9FbGVtZW50IH0gZnJvbSAnLi90ZW1wb0VsZW1lbnQnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5cbi8vIFRoZXNlIGNvbnN0YW50cyBtYXRjaCB3aGF0IHRlbXBvLWFwaSBoYXNcbmV4cG9ydCBjb25zdCBXUkFQX0lOX0RJVl9QTEFDRUhPTERFUl9DT0RFQkFTRV9JRCA9XG4gICd0ZW1wby13cmFwLWluLWRpdi1wbGFjZWhvbGRlcic7XG5leHBvcnQgY29uc3QgRFVQTElDQVRFX1BMQUNFSE9MREVSX1BSRUZJWCA9ICd0ZW1wby1kdXBsaWNhdGUtcGxhY2Vob2xkZXItJztcbmV4cG9ydCBjb25zdCBBRERfSlNYX1BSRUZJWCA9ICd0ZW1wby1hZGQtanN4LXBsYWNlaG9sZGVyLSc7XG5cbi8vIFN0b3JlZCBpbiBtZW1vcnkgc3RvcmFnZSwgdXNlZCB0byBrZWVwIHRyYWNrIG9mIHNvbWUgcG9zc2libGUgYWRkIGNsYXNzIGluc3RhbnRcbi8vIHVwZGF0ZXMgdGhhdCBuZWVkIHRvIGJlIHJlLWFwcGxpZWQgYWZ0ZXIgYSBob3QgcmVsb2FkXG4vLyAoZS5nLiB3aGVuIHRoZSBhZGRpdGlvbmFsKSBpbnN0YW50IHVwZGF0ZXMgaGFwcGVuZWQgZHVyaW5nIGZsdXNoaW5nXG5leHBvcnQgY29uc3QgQUREX0NMQVNTX0lOU1RBTlRfVVBEQVRFX1FVRVVFID0gJ0FERF9DTEFTU19JTlNUQU5UX1VQREFURV9RVUVVRSc7XG5cbmV4cG9ydCBjb25zdCBURU1QT1JBUllfU1RZTElOR19DTEFTU19OQU1FID0gJ2FyYjg5LXRlbXAtc3R5bGluZyc7XG5cbmNvbnN0IGdldFRvcExldmVsQ29kZWJhc2VJZEZvckNvbXBvbmVudCA9IChjb21wb25lbnRJZDogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgbGV0IHRvcExldmVsQ29kZWJhc2VJZDogYW55ID0gbnVsbDtcbiAgbGV0IG1pbk51bWJlclBhcmVudHMgPSBJbmZpbml0eTtcbiAgJChgLmNvbXBvbmVudC0ke2NvbXBvbmVudElkfWApLmVhY2goKGluZGV4OiBhbnksIGVsZW1lbnQ6IGFueSkgPT4ge1xuICAgIGlmICgkKGVsZW1lbnQpLnBhcmVudHMoKS5sZW5ndGggPCBtaW5OdW1iZXJQYXJlbnRzKSB7XG4gICAgICBtaW5OdW1iZXJQYXJlbnRzID0gJChlbGVtZW50KS5wYXJlbnRzKCkubGVuZ3RoO1xuICAgICAgdG9wTGV2ZWxDb2RlYmFzZUlkID0gZ2V0Q29kZWJhc2VJZEZyb21Ob2RlKGVsZW1lbnQpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHRvcExldmVsQ29kZWJhc2VJZDtcbn07XG5cbmNvbnN0IG1ha2VpZCA9IChsZW5ndGg6IG51bWJlcik6IHN0cmluZyA9PiB7XG4gIGxldCByZXN1bHQgPSAnJztcbiAgY29uc3QgY2hhcmFjdGVycyA9XG4gICAgJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5JztcbiAgY29uc3QgY2hhcmFjdGVyc0xlbmd0aCA9IGNoYXJhY3RlcnMubGVuZ3RoO1xuICBsZXQgY291bnRlciA9IDA7XG4gIHdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7XG4gICAgcmVzdWx0ICs9IGNoYXJhY3RlcnMuY2hhckF0KE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJhY3RlcnNMZW5ndGgpKTtcbiAgICBjb3VudGVyICs9IDE7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmxldCBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZToge1xuICBbY29kZWJhc2VJZDogc3RyaW5nXTogc3RyaW5nW107XG59ID0ge307XG5cbmV4cG9ydCBjb25zdCByZXNldEludGVybWVkaWF0ZUNsYXNzZXNGb3JTbGlkZXJJbnN0YW50VXBkYXRlID0gKCkgPT4ge1xuICBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZSA9IHt9O1xufTtcblxuY29uc3Qgc2l6ZVZhcmlhbnRUb1dyYXA6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gIHNtOiAnQG1lZGlhICh3aWR0aCA+PSA0MHJlbSknLFxuICBtZDogJ0BtZWRpYSAod2lkdGggPj0gNDhyZW0pJyxcbiAgbGc6ICdAbWVkaWEgKHdpZHRoID49IDY0cmVtKScsXG4gIHhsOiAnQG1lZGlhICh3aWR0aCA+PSA4MHJlbSknLFxuICAnMnhsJzogJ0BtZWRpYSAod2lkdGggPj0gOTZyZW0pJyxcbn07XG5cbmNvbnN0IGFkZENsYXNzQ3NzUnVsZSA9IChcbiAgY2xhc3NOYW1lOiBzdHJpbmcsXG4gIHJ1bGVzOiBzdHJpbmcsXG4gIGlkPzogc3RyaW5nLFxuICB2YXJpYW50Pzogc3RyaW5nIHwgbnVsbCxcbikgPT4ge1xuICBsZXQgc2VsZWN0b3IgPSBjbGFzc05hbWVcbiAgICAucmVwbGFjZSgvXFxbL2csICdcXFxcWycpXG4gICAgLnJlcGxhY2UoL1xcXS9nLCAnXFxcXF0nKVxuICAgIC5yZXBsYWNlKC9cXCgvZywgJ1xcXFwoJylcbiAgICAucmVwbGFjZSgvXFwpL2csICdcXFxcKScpXG4gICAgLnJlcGxhY2UoL1xcLi9nLCAnXFxcXC4nKVxuICAgIC5yZXBsYWNlKC9cXCUvZywgJ1xcXFwlJylcbiAgICAucmVwbGFjZSgvXFwhL2csICdcXFxcIScpXG4gICAgLnJlcGxhY2UoL1xcLy9nLCAnXFxcXC8nKVxuICAgIC5yZXBsYWNlKC8jL2csICdcXFxcIycpO1xuXG4gIGxldCBydWxlVG9TZXQgPSBydWxlcztcblxuICBpZiAodmFyaWFudCAmJiB2YXJpYW50ICE9PSAnZGVmYXVsdCcpIHtcbiAgICBzZWxlY3RvciA9IGAke3ZhcmlhbnR9XFxcXDoke3NlbGVjdG9yfWA7XG5cbiAgICBpZiAodmFyaWFudCA9PT0gJ2hvdmVyJykge1xuICAgICAgc2VsZWN0b3IgPSBgJHtzZWxlY3Rvcn06aG92ZXJgO1xuICAgIH0gZWxzZSBpZiAoc2l6ZVZhcmlhbnRUb1dyYXBbdmFyaWFudF0pIHtcbiAgICAgIHJ1bGVUb1NldCA9IGAke3NpemVWYXJpYW50VG9XcmFwW3ZhcmlhbnRdfSB7ICR7cnVsZXN9IH1gO1xuICAgIH1cbiAgfVxuXG4gIHNlbGVjdG9yID0gYC4ke3NlbGVjdG9yfWA7XG4gIHRyeSB7XG4gICAgYWRkT3JFZGl0Q1NTUnVsZShzZWxlY3RvciwgcnVsZVRvU2V0LCBpZCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZygnRXJyb3IgYWRkaW5nIGNsYXNzIENTUyBydWxlJywgZSk7XG4gIH1cbn07XG5cbmNvbnN0IGFkZE9yRWRpdENTU1J1bGUgPSAoc2VsZWN0b3I6IHN0cmluZywgcnVsZXM6IHN0cmluZywgaWQ/OiBzdHJpbmcpID0+IHtcbiAgdmFyIHN0eWxlRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuXG4gIGlmIChpZCkge1xuICAgIGNvbnN0IGV4aXN0aW5nRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcbiAgICBpZiAoZXhpc3RpbmdFbGVtZW50KSB7XG4gICAgICBleGlzdGluZ0VsZW1lbnQucmVtb3ZlKCk7XG4gICAgfVxuXG4gICAgc3R5bGVFbC5pZCA9IGlkO1xuICB9XG5cbiAgLy8gQXBwZW5kIDxzdHlsZT4gZWxlbWVudCB0byA8aGVhZD5cbiAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZUVsKTtcblxuICB2YXIgc3R5bGVTaGVldDogYW55ID0gc3R5bGVFbC5zaGVldDtcblxuICBpZiAoc3R5bGVTaGVldC5pbnNlcnRSdWxlKSB7XG4gICAgLy8gQWxsIGJyb3dzZXJzLCBleGNlcHQgSUUgYmVmb3JlIHZlcnNpb24gOVxuICAgIHN0eWxlU2hlZXQuaW5zZXJ0UnVsZShcbiAgICAgIHNlbGVjdG9yICsgJ3snICsgcnVsZXMgKyAnfScsXG4gICAgICBzdHlsZVNoZWV0LmNzc1J1bGVzLmxlbmd0aCxcbiAgICApO1xuICB9IGVsc2UgaWYgKHN0eWxlU2hlZXQuYWRkUnVsZSkge1xuICAgIC8vIElFIGJlZm9yZSB2ZXJzaW9uIDlcbiAgICBzdHlsZVNoZWV0LmFkZFJ1bGUoc2VsZWN0b3IsIHJ1bGVzLCBzdHlsZVNoZWV0LnJ1bGVzLmxlbmd0aCk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBnZXRGdWxsSHRtbFdpdGhFbGVtZW50ID0gKFxuICBlbGVtZW50S2V5czogKHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQpW10sXG4pOiBzdHJpbmcgfCB1bmRlZmluZWQgPT4ge1xuICBjb25zdCB2YWxpZEVsZW1lbnRLZXlzID0gZWxlbWVudEtleXMuZmlsdGVyKFxuICAgIChlbGVtZW50S2V5KSA9PiBlbGVtZW50S2V5ICE9PSBudWxsICYmIGVsZW1lbnRLZXkgIT09IHVuZGVmaW5lZCxcbiAgKTtcbiAgaWYgKCF2YWxpZEVsZW1lbnRLZXlzPy5sZW5ndGgpIHJldHVybiB1bmRlZmluZWQ7XG5cbiAgY29uc3QgZWxlbWVudHMgPSB2YWxpZEVsZW1lbnRLZXlzXG4gICAgLm1hcCgoZWxlbWVudEtleSkgPT4gZ2V0Tm9kZUZvckVsZW1lbnRLZXkoZWxlbWVudEtleSkpXG4gICAgLmZpbHRlcigoZWxlbWVudCkgPT4gZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50ICE9PSB1bmRlZmluZWQpO1xuICBpZiAoIWVsZW1lbnRzLmxlbmd0aCB8fCBlbGVtZW50cy5sZW5ndGggIT09IHZhbGlkRWxlbWVudEtleXMubGVuZ3RoKVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG5cbiAgLy8gR2V0IHRoZSBjb21wbGV0ZSBkb2N1bWVudCBIVE1MXG4gIGNvbnN0IGZ1bGxEb2N1bWVudEh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MO1xuXG4gIC8vIFJlcGxhY2UgdGhlIGJvZHkgY29udGVudHMgd2l0aCBqdXN0IG91ciBzcGVjaWZpYyBlbGVtZW50XG4gIC8vIFRoaXMgcHJlc2VydmVzIHRoZSBleGFjdCBkb2N1bWVudCBzdHJ1Y3R1cmUsIGRvY3R5cGUsIGh0bWwgYXR0cmlidXRlcywgYW5kIGhlYWQgY29udGVudHNcbiAgcmV0dXJuIGZ1bGxEb2N1bWVudEh0bWwucmVwbGFjZShcbiAgICAvPGJvZHlbXj5dKj5bXFxzXFxTXSo8XFwvYm9keT4vaSxcbiAgICBgPGJvZHk+JHtlbGVtZW50cy5tYXAoKGVsZW1lbnQpID0+IGVsZW1lbnQ/Lm91dGVySFRNTCkuam9pbignJyl9PC9ib2R5PmAsXG4gICk7XG59O1xuXG5leHBvcnQgY29uc3QgYXBwbHlDaGFuZ2VJdGVtVG9Eb2N1bWVudCA9IChcbiAgcGFyZW50UG9ydDogTWVzc2FnZVBvcnQsXG4gIHN0b3J5Ym9hcmRJZDogc3RyaW5nLFxuICBwbGFpbkNoYW5nZUl0ZW06IEFueUNoYW5nZUxlZGdlckl0ZW0sXG4pOiB7IHNlbmROZXdOYXZUcmVlOiBib29sZWFuOyBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bDogYm9vbGVhbiB9ID0+IHtcbiAgaWYgKCFwbGFpbkNoYW5nZUl0ZW0gfHwgIXBsYWluQ2hhbmdlSXRlbS50eXBlKSB7XG4gICAgcmV0dXJuIHsgc2VuZE5ld05hdlRyZWU6IGZhbHNlLCBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bDogZmFsc2UgfTtcbiAgfVxuXG4gIGNvbnN0IGNoYW5nZUl0ZW0gPSByZWNvbnN0cnVjdENoYW5nZUxlZGdlckNsYXNzKFxuICAgIHBsYWluQ2hhbmdlSXRlbSxcbiAgKSBhcyBBbnlDaGFuZ2VMZWRnZXJJdGVtO1xuXG4gIGxldCBleHRyYUluc3RhbnRVcGRhdGVEYXRhOiBhbnkgPSB7fTtcbiAgbGV0IGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gZmFsc2U7XG5cbiAgLy8gVGhlIGRpc3BsYXk6IG5vbmUgcnVsZSBpcyBuZWVkZWQgZm9yIGEgbG90IG9mIGluc3RhbnQgdXBkYXRlcywgc28gY3JlYXRlIGl0IGlmIGl0IGRvZXNuJ3QgZXhpc3RcbiAgaWYgKCFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUykpIHtcbiAgICBhZGRDbGFzc0Nzc1J1bGUoXG4gICAgICBURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyxcbiAgICAgICdkaXNwbGF5OiBub25lICFpbXBvcnRhbnQnLFxuICAgICAgVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MsXG4gICAgKTtcbiAgfVxuXG4gIGxldCBzZW5kTmV3TmF2VHJlZSA9IGZhbHNlO1xuICBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLkFERF9KU1gpIHtcbiAgICBjb25zdCBjYXN0Q2hhbmdlSXRlbSA9IGNoYW5nZUl0ZW0gYXMgQWRkSnN4Q2hhbmdlO1xuICAgIGNvbnN0IGNoYW5nZUZpZWxkcyA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcztcblxuICAgIGNvbnN0IG5ld0FkZGVkSWRzID0gW107XG5cbiAgICBpZiAoY2hhbmdlRmllbGRzLmh0bWxGb3JJbnN0YW50VXBkYXRlKSB7XG4gICAgICBjb25zdCBodG1sID0gY2hhbmdlRmllbGRzLmh0bWxGb3JJbnN0YW50VXBkYXRlO1xuICAgICAgLy8gU29tZSBodG1sIHByb3ZpZGVkIGhhcyB0aGUgZnVsbCBzdHJ1Y3R1cmUgaW5jbHVkaW5nIGh0bWwsIGJvZHksIGhlYWRlciwgZXRjIHNvIHRoYXQgaXQgZGlzcGxheXMgY29ycmVjdGx5IGluIGEgcHJldmlld1xuICAgICAgLy8gaWZyYW1lLiBXZSBqdXN0IHdhbnQgdG8gc3RyaXAgdGhpcyBhbmQgdGFrZSB0aGUgY29udGVudHMgb2YgdGhlIGJvZHkuXG4gICAgICBjb25zdCBlbGVtZW50VG9BZGQgPSAkKFxuICAgICAgICBodG1sLmluY2x1ZGVzKCc8Ym9keScpXG4gICAgICAgICAgPyBodG1sLnJlcGxhY2UoLzxib2R5W14+XSo+KFtcXHNcXFNdKik8XFwvYm9keT4vaSwgJyQxJylcbiAgICAgICAgICA6IGh0bWwsXG4gICAgICApO1xuICAgICAgZWxlbWVudFRvQWRkLmF0dHIoVEVNUE9fREVMRVRFX0FGVEVSX1JFRlJFU0gsICd0cnVlJyk7XG4gICAgICBlbGVtZW50VG9BZGQuYXR0cihURU1QT19JTlNUQU5UX1VQREFURSwgJ3RydWUnKTsgLy8gU28gdGhhdCB0aGUgRE9NIHRyZWUgcmVmcmVzaCBkb2Vzbid0IGdldCB0cmlnZ2VyZWRcbiAgICAgIGVsZW1lbnRUb0FkZC5hdHRyKFRFTVBPX09VVExJTkVfVU5USUxfUkVGRVNILCAndHJ1ZScpO1xuXG4gICAgICBjb25zdCBJRF9GT1JfRUxFTUVOVCA9IGAke0FERF9KU1hfUFJFRklYfSR7dXVpZHY0KCl9YDtcbiAgICAgIGVsZW1lbnRUb0FkZC5hdHRyKFRFTVBPX0VMRU1FTlRfSUQsIElEX0ZPUl9FTEVNRU5UKTtcbiAgICAgIGVsZW1lbnRUb0FkZC5hZGRDbGFzcyhJRF9GT1JfRUxFTUVOVCk7XG5cbiAgICAgIG5ld0FkZGVkSWRzLnB1c2goSURfRk9SX0VMRU1FTlQpO1xuXG4gICAgICAkKGAuJHtjaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQWRkVG99YCkuZWFjaCgoaW5kZXg6IGFueSwgaXRlbSkgPT4ge1xuICAgICAgICBpZiAoY2hhbmdlRmllbGRzLmFmdGVyQ29kZWJhc2VJZCkge1xuICAgICAgICAgIGNvbnN0IGFmdGVyRWxlbWVudCA9ICQoYC4ke2NoYW5nZUZpZWxkcy5hZnRlckNvZGViYXNlSWR9YCk7XG4gICAgICAgICAgaWYgKCFhZnRlckVsZW1lbnQ/Lmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGVsZW1lbnRUb0FkZC5pbnNlcnRBZnRlcihhZnRlckVsZW1lbnQuZmlyc3QoKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlRmllbGRzLmJlZm9yZUNvZGViYXNlSWQpIHtcbiAgICAgICAgICBjb25zdCBiZWZvcmVFbGVtZW50ID0gJChgLiR7Y2hhbmdlRmllbGRzLmJlZm9yZUNvZGViYXNlSWR9YCk7XG4gICAgICAgICAgaWYgKCFiZWZvcmVFbGVtZW50Py5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxlbWVudFRvQWRkLmluc2VydEJlZm9yZShiZWZvcmVFbGVtZW50LmZpcnN0KCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICQoaXRlbSkuYXBwZW5kKGVsZW1lbnRUb0FkZCk7XG4gICAgICAgIH1cblxuICAgICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICAgIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGV4dHJhSW5zdGFudFVwZGF0ZURhdGFbJ25ld0FkZGVkSWRzJ10gPSBuZXdBZGRlZElkcztcbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuTU9WRV9KU1gpIHtcbiAgICBjb25zdCBjYXN0Q2hhbmdlSXRlbTogTW92ZUpzeENoYW5nZSA9IGNoYW5nZUl0ZW0gYXMgTW92ZUpzeENoYW5nZTtcblxuICAgIC8vIEZpbmQgZWFjaCBlbGVtZW50IHRoYXQgbWF0Y2hlcyB0aGUganN4Q29kZWJhc2VJZFxuICAgIGNvbnN0IHNvdXJjZUVsZW1lbnRzOiBKUXVlcnk8YW55PltdID0gW107XG5cbiAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgIGlmICgkKGAuJHtjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvTW92ZX1gKS5sZW5ndGggPiAwKSB7XG4gICAgICAkKGAuJHtjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvTW92ZX1gKS5lYWNoKFxuICAgICAgICAoaW5kZXg6IGFueSwgZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgc291cmNlRWxlbWVudHMucHVzaCgkKGVsZW1lbnQpKTtcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRyeSB0byBmaW5kIGl0IGJ5IHRoZSBjb21wb25lbnQgSURcbiAgICAgIGxldCB0b3BMZXZlbENvZGViYXNlSWQgPSBnZXRUb3BMZXZlbENvZGViYXNlSWRGb3JDb21wb25lbnQoXG4gICAgICAgIGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9Nb3ZlIHx8ICcnLFxuICAgICAgKTtcblxuICAgICAgaWYgKHRvcExldmVsQ29kZWJhc2VJZCkge1xuICAgICAgICAkKGAuJHt0b3BMZXZlbENvZGViYXNlSWR9YCkuZWFjaCgoaW5kZXg6IGFueSwgZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgc291cmNlRWxlbWVudHMucHVzaCgkKGVsZW1lbnQpKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSWYgdGhlIGNvbnRhaW5lciBpcyBhIGNvbXBvbmVudCwgZHJvcCBpbnRvIHRoZSBjb2RlYmFzZUlkIG9mIHRoZSB0b3AtbW9zdCBjaGlsZCBkaXZcbiAgICBsZXQgY29udGFpbmVyQ29kZWJhc2VJZCA9XG4gICAgICBnZXRUb3BMZXZlbENvZGViYXNlSWRGb3JDb21wb25lbnQoXG4gICAgICAgIGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9Nb3ZlVG8gfHwgJycsXG4gICAgICApIHx8IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9Nb3ZlVG87XG5cbiAgICAvLyBGb3IgZWFjaCBzb3VyY2UgZWxlbWVudCwgZmluZCB0aGUgbmV3IG1hdGNoaW5nIHBhcmVudCBlbGVtZW50XG4gICAgY29uc3QgbmV3UGFyZW50RWxlbWVudHM6IGFueVtdID0gW107XG4gICAgc291cmNlRWxlbWVudHMuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgICAgbGV0IG5ld1BhcmVudEVsZW1lbnQgPSBudWxsO1xuXG4gICAgICAvLyBGb3IgZWFjaCBwYXJlbnQsIHRyeSB0byBzZWUgaWYgaXQgZWl0aGVyIG1hdGNoZXMgb3IgY29udGFpbnMgdGhlIG5ldyBwYXJlbnRcbiAgICAgIGxldCBwYXJlbnRFbGVtZW50ID0gZWxlbWVudC5wYXJlbnQoKTtcbiAgICAgIHdoaWxlIChwYXJlbnRFbGVtZW50Lmxlbmd0aCkge1xuICAgICAgICAvLyBJZiB0aGUgcGFyZW50IGRpcmVjdGx5IG1hdGNoZXMsIHRoaXMgaXMgaXRcbiAgICAgICAgaWYgKHBhcmVudEVsZW1lbnQuaGFzQ2xhc3MoY29udGFpbmVyQ29kZWJhc2VJZCkpIHtcbiAgICAgICAgICBuZXdQYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGNoaWxkcmVuIHRoYXQgbWF0Y2ggdGhlIGNvZGViYXNlIElEIHRvIGRyb3AgaW50b1xuICAgICAgICBjb25zdCBtYXRjaGluZ0NoaWxkcmVuID0gcGFyZW50RWxlbWVudC5maW5kKGAuJHtjb250YWluZXJDb2RlYmFzZUlkfWApO1xuICAgICAgICBpZiAobWF0Y2hpbmdDaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAvLyBUT0RPOiBXaGF0IGlmIHRoaXMgbWF0Y2hlcyBtb3JlIHRoYW4gb25lP1xuICAgICAgICAgIG5ld1BhcmVudEVsZW1lbnQgPSBtYXRjaGluZ0NoaWxkcmVuLmZpcnN0KCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBwYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudC5wYXJlbnQoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFuZXdQYXJlbnRFbGVtZW50KSB7XG4gICAgICAgIG5ld1BhcmVudEVsZW1lbnRzLnB1c2gobnVsbCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbmV3UGFyZW50RWxlbWVudHMucHVzaChuZXdQYXJlbnRFbGVtZW50KTtcbiAgICB9KTtcblxuICAgIC8vIEZvciBlYWNoIGNoaWxkL3BhcmVudEVsZW1lbnQgcGFpciwgbW92ZSB0aGUgY2hpbGQgdG8gdGhlIG5ldyBwYXJlbnRcbiAgICBzb3VyY2VFbGVtZW50cy5mb3JFYWNoKChlbGVtZW50LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICBjb25zdCBuZXdQYXJlbnRFbGVtZW50ID0gbmV3UGFyZW50RWxlbWVudHNbaW5kZXhdO1xuXG4gICAgICBpZiAoIW5ld1BhcmVudEVsZW1lbnQubGVuZ3RoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdDb3VsZCBub3QgZmluZCBuZXcgcGFyZW50IGVsZW1lbnQgZm9yIGluc3RhbnQgdXBkYXRlJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgc2VuZE5ld05hdlRyZWUgPSB0cnVlO1xuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuXG4gICAgICBlbGVtZW50LmF0dHIoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7XG5cbiAgICAgIC8vIElmIHRoZSBwYXJlbnQgaGFzbid0IGNoYW5nZWQsIGp1c3QgbW92ZSBpdCwgb3RoZXJ3aXNlIGNsb25lIGl0IGFuZCBjcmVhdGUgYSBuZXcgb25lIGluIHRoZSBuZXcgc3BvdFxuICAgICAgbGV0IHVzZUNsb25lID0gIW5ld1BhcmVudEVsZW1lbnQuaXMoZWxlbWVudC5wYXJlbnQoKSk7XG5cbiAgICAgIC8vIFNvIHRoYXQgbmV4dGpzIGhvdCByZWxvYWRpbmcgd29ya3MsIHNpbXBseSBoaWRlIHRoZSBlbGVtZW50IGFuZCBjbG9uZSBpdCBpbnRvIHRoZSBuZXcgc3BvdFxuICAgICAgbGV0IGNsb25lRWxlbWVudDtcbiAgICAgIGlmICh1c2VDbG9uZSkge1xuICAgICAgICBjbG9uZUVsZW1lbnQgPSBlbGVtZW50LmNsb25lKCk7XG4gICAgICAgIGNsb25lRWxlbWVudC5hdHRyKFRFTVBPX0RFTEVURV9BRlRFUl9SRUZSRVNILCAndHJ1ZScpO1xuXG4gICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MpO1xuICAgICAgICBlbGVtZW50LmF0dHIoVEVNUE9fRE9fTk9UX1NIT1dfSU5fTkFWX1VOVElMX1JFRlJFU0gsICd0cnVlJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuYWZ0ZXJDb2RlYmFzZUlkKSB7XG4gICAgICAgIGNvbnN0IGFmdGVySWRUb1VzZSA9XG4gICAgICAgICAgZ2V0VG9wTGV2ZWxDb2RlYmFzZUlkRm9yQ29tcG9uZW50KFxuICAgICAgICAgICAgY2FzdENoYW5nZUl0ZW0uY2hhbmdlRmllbGRzLmFmdGVyQ29kZWJhc2VJZCxcbiAgICAgICAgICApIHx8IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5hZnRlckNvZGViYXNlSWQ7XG4gICAgICAgIGNvbnN0IGFmdGVyRWxlbWVudCA9IG5ld1BhcmVudEVsZW1lbnQuY2hpbGRyZW4oYC4ke2FmdGVySWRUb1VzZX1gKTtcbiAgICAgICAgaWYgKGFmdGVyRWxlbWVudC5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAodXNlQ2xvbmUgJiYgY2xvbmVFbGVtZW50KSB7XG4gICAgICAgICAgICBjbG9uZUVsZW1lbnQuaW5zZXJ0QWZ0ZXIoYWZ0ZXJFbGVtZW50LmZpcnN0KCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbGVtZW50Lmluc2VydEFmdGVyKGFmdGVyRWxlbWVudC5maXJzdCgpKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5iZWZvcmVDb2RlYmFzZUlkKSB7XG4gICAgICAgIGNvbnN0IGJlZm9yZUlkVG9Vc2UgPVxuICAgICAgICAgIGdldFRvcExldmVsQ29kZWJhc2VJZEZvckNvbXBvbmVudChcbiAgICAgICAgICAgIGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5iZWZvcmVDb2RlYmFzZUlkLFxuICAgICAgICAgICkgfHwgY2FzdENoYW5nZUl0ZW0uY2hhbmdlRmllbGRzLmJlZm9yZUNvZGViYXNlSWQ7XG4gICAgICAgIGNvbnN0IGJlZm9yZUVsZW1lbnQgPSBuZXdQYXJlbnRFbGVtZW50LmNoaWxkcmVuKGAuJHtiZWZvcmVJZFRvVXNlfWApO1xuICAgICAgICBpZiAoYmVmb3JlRWxlbWVudC5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAodXNlQ2xvbmUgJiYgY2xvbmVFbGVtZW50KSB7XG4gICAgICAgICAgICBjbG9uZUVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJlZm9yZUVsZW1lbnQuZmlyc3QoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJlZm9yZUVsZW1lbnQuZmlyc3QoKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodXNlQ2xvbmUgJiYgY2xvbmVFbGVtZW50KSB7XG4gICAgICAgIGNsb25lRWxlbWVudC5hcHBlbmRUbyhuZXdQYXJlbnRFbGVtZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW1lbnQuYXBwZW5kVG8obmV3UGFyZW50RWxlbWVudCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLlJFTU9WRV9KU1gpIHtcbiAgICBjb25zdCBjYXN0Q2hhbmdlSXRlbTogUmVtb3ZlSnN4Q2hhbmdlID0gY2hhbmdlSXRlbSBhcyBSZW1vdmVKc3hDaGFuZ2U7XG5cbiAgICBjb25zdCBwYXJlbnRUb0VsZW1lbnRLZXlzUmVtb3ZlZDogYW55ID0ge307XG5cbiAgICBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZHNUb1JlbW92ZS5mb3JFYWNoKFxuICAgICAgKGNvZGViYXNlSWQ6IHN0cmluZykgPT4ge1xuICAgICAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgICAgICBsZXQgY29kZWJhc2VJZFRvUmVtb3ZlO1xuICAgICAgICBpZiAoJChgLiR7Y29kZWJhc2VJZH1gKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29kZWJhc2VJZFRvUmVtb3ZlID0gY29kZWJhc2VJZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBUcnkgdG8gZmluZCBpdCBieSB0aGUgY29tcG9uZW50IElEXG4gICAgICAgICAgbGV0IHRvcExldmVsQ29kZWJhc2VJZCA9IGdldFRvcExldmVsQ29kZWJhc2VJZEZvckNvbXBvbmVudChcbiAgICAgICAgICAgIGNvZGViYXNlSWQgfHwgJycsXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmICghdG9wTGV2ZWxDb2RlYmFzZUlkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ291bGQgbm90IGZpbmQgY29tcG9uZW50IGVsZW1lbnQgZm9yIGluc3RhbnQgdXBkYXRlJyk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29kZWJhc2VJZFRvUmVtb3ZlID0gdG9wTGV2ZWxDb2RlYmFzZUlkO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRm9yIGVhY2ggaXRlbSB0aGF0IGlzIHJlbW92ZWQsIHNhdmUgdGhlIGlubmVyIEhUTUwgaW4gY2FzZSBpdCBnZXRzIGRlbGV0ZWQgYW5kIHdlIHdhbnQgdG8gdW5kb1xuICAgICAgICAkKGAuJHtjb2RlYmFzZUlkVG9SZW1vdmV9YCkuZWFjaCgoaW5kZXg6IGFueSwgaXRlbSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGVsZW1lbnRLZXlSZW1vdmVkID0gZ2V0RWxlbWVudEtleUZyb21Ob2RlKGl0ZW0pO1xuICAgICAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnRLZXkgPSBnZXRFbGVtZW50S2V5RnJvbU5vZGUoaXRlbS5wYXJlbnRFbGVtZW50KTtcblxuICAgICAgICAgIGlmIChlbGVtZW50S2V5UmVtb3ZlZCAmJiBwYXJlbnRFbGVtZW50S2V5KSB7XG4gICAgICAgICAgICBpZiAoIXBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkW3BhcmVudEVsZW1lbnRLZXldKSB7XG4gICAgICAgICAgICAgIHBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkW3BhcmVudEVsZW1lbnRLZXldID0gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkW3BhcmVudEVsZW1lbnRLZXldLnB1c2goe1xuICAgICAgICAgICAgICBvdXRlckhUTUw6IGl0ZW0ub3V0ZXJIVE1MLFxuICAgICAgICAgICAgICBlbGVtZW50S2V5UmVtb3ZlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZChURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyk7XG4gICAgICAgICAgaXRlbS5zZXRBdHRyaWJ1dGUoVEVNUE9fRE9fTk9UX1NIT1dfSU5fTkFWX1VOVElMX1JFRlJFU0gsICd0cnVlJyk7XG5cbiAgICAgICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGV4dHJhSW5zdGFudFVwZGF0ZURhdGEucGFyZW50VG9FbGVtZW50S2V5c1JlbW92ZWQgPVxuICAgICAgcGFyZW50VG9FbGVtZW50S2V5c1JlbW92ZWQ7XG4gIH0gZWxzZSBpZiAoXG4gICAgY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLkFERF9DTEFTUyB8fFxuICAgIGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5TVFlMSU5HXG4gICkge1xuICAgIGxldCBjbGFzc05hbWUsXG4gICAgICBjc3NFcXVpdmFsZW50LFxuICAgICAgY29kZWJhc2VJZFRvQWRkQ2xhc3MsXG4gICAgICB0ZW1wb3JhcnlDbGFzcyxcbiAgICAgIGNvZGViYXNlQ2xhc3NOYW1lLFxuICAgICAgbW9kaWZpZXJzO1xuXG4gICAgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5BRERfQ0xBU1MpIHtcbiAgICAgIGNvbnN0IGNhc3RDaGFuZ2VJdGVtOiBBZGRDbGFzc0NoYW5nZSA9IGNoYW5nZUl0ZW0gYXMgQWRkQ2xhc3NDaGFuZ2U7XG4gICAgICBjb2RlYmFzZUNsYXNzTmFtZSA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jbGFzc05hbWU7XG4gICAgICBjbGFzc05hbWUgPSBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY2xhc3NOYW1lO1xuICAgICAgY3NzRXF1aXZhbGVudCA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jc3NFcXVpdmFsZW50O1xuICAgICAgY29kZWJhc2VJZFRvQWRkQ2xhc3MgPSBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQWRkQ2xhc3M7XG4gICAgICB0ZW1wb3JhcnlDbGFzcyA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy50ZW1wb3JhcnlPbmx5O1xuICAgICAgbW9kaWZpZXJzID0gY2FzdENoYW5nZUl0ZW0uY2hhbmdlRmllbGRzLm1vZGlmaWVycztcbiAgICAgIGlmICh0ZW1wb3JhcnlDbGFzcykge1xuICAgICAgICBjbGFzc05hbWUgPSBURU1QT1JBUllfU1RZTElOR19DTEFTU19OQU1FO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBBcyBvZiBNYXJjaCA2LCAyMDI0IHdlIG9ubHkgc3VwcG9ydCB0YWlsd2luZCBTVFlMSU5HIGNoYW5nZXMsIHNvIHRyZWF0IHRoZW0gYXMgYWRkaW5nIGEgY2xhc3NcbiAgICAgIGNvbnN0IGNhc3RDaGFuZ2VJdGVtOiBTdHlsaW5nQ2hhbmdlRmllbGRzID1cbiAgICAgICAgY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgU3R5bGluZ0NoYW5nZUZpZWxkcztcbiAgICAgIGNsYXNzTmFtZSA9ICcnO1xuICAgICAgY3NzRXF1aXZhbGVudCA9IE9iamVjdC5rZXlzKGNhc3RDaGFuZ2VJdGVtLnN0eWxpbmdDaGFuZ2VzKVxuICAgICAgICAubWFwKChrZXkpID0+IHtcbiAgICAgICAgICBpZiAoY2FzdENoYW5nZUl0ZW0uc3R5bGluZ0NoYW5nZXNba2V5XSA9PT0gREVMRVRFX1NUWUxFX0NPTlNUQU5UKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7Y2FtZWxUb1NuYWtlQ2FzZShrZXkpfTogdW5zZXQgIWltcG9ydGFudDtgO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBgJHtjYW1lbFRvU25ha2VDYXNlKGtleSl9OiAke1xuICAgICAgICAgICAgY2FzdENoYW5nZUl0ZW0uc3R5bGluZ0NoYW5nZXNba2V5XVxuICAgICAgICAgIH07YDtcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJycpO1xuICAgICAgY29kZWJhc2VJZFRvQWRkQ2xhc3MgPSBjYXN0Q2hhbmdlSXRlbS5jb2RlYmFzZUlkO1xuICAgICAgbW9kaWZpZXJzID0gY2FzdENoYW5nZUl0ZW0ubW9kaWZpZXJzO1xuICAgIH1cbiAgICBjb25zdCBTQUZFX0NMQVNTTkFNRV9SRUdFWCA9IC9bXkEtWmEtejAtOV8tXS9nO1xuXG4gICAgLy8gRXNjYXBlIGFueSBjdXN0b20gY2xhc3Nlc1xuICAgIGxldCBjbGFzc1RvQWRkID0gKGNsYXNzTmFtZSB8fCAnJylcbiAgICAgIC5yZXBsYWNlKFNBRkVfQ0xBU1NOQU1FX1JFR0VYLCAnLScpIC8vIFJlcGxhY2UgYW55IG5vbi1hbHBoYW51bWVyaWMgY2hhcmFjdGVycyB3aXRoICctJ1xuICAgICAgLnJlcGxhY2UoL15cXGQvLCAnLSQmJyk7IC8vIElmIHRoZSBjbGFzcyBzdGFydHMgd2l0aCBhIGRpZ2l0LCBwcmVwZW5kIHdpdGggJy0nXG5cbiAgICAvLyBJbnN0ZWFkIG9mIGFkZGluZyB0aGUgY2xhc3MgbmFtZSwgZ2VuZXJhdGUgYSBuZXcgY2xhc3MgYW5kIHNldCB0aGVcbiAgICAvLyBjc3MgZXF1aXZhbGVudCB2YWx1ZXMgaW5zaWRlIGl0XG4gICAgLy8gVGhpcyBjbGFzcyB3aWxsIGJlIGRlbGV0ZWQgYWZ0ZXIgYSBob3QgcmVsb2FkXG4gICAgLy8gTm90ZSAtIGZvciB0ZW1wb3JhcnkgY2xhc3NlcyB3ZSB3YW50IHRvIGV4cGxpY2l0bHkgdXNlIHRoZSBzYW1lIGNsYXNzXG4gICAgaWYgKGNzc0VxdWl2YWxlbnQgJiYgIXRlbXBvcmFyeUNsYXNzKSB7XG4gICAgICBjb25zdCBtc1NpbmNlSmFuMSA9IERhdGUubm93KCkgLSAxNzA0MDY3MjAwMDAwO1xuICAgICAgY2xhc3NUb0FkZCA9IGAke1RFTVBPX0lOU1RBTlRfVVBEQVRFX1NUWUxJTkdfUFJFRklYfSR7bXNTaW5jZUphbjF9LSR7Y2xhc3NUb0FkZH1gO1xuICAgIH1cblxuICAgIGlmIChjbGFzc1RvQWRkKSB7XG4gICAgICBpZiAoIXRlbXBvcmFyeUNsYXNzKSB7XG4gICAgICAgIC8vIENsZWFyIHRoZSB0ZW1wb3JhcnkgY2xhc3Mgb24gdGhpcyBlbGVtZW50IGlmIGl0IGhhcyBpdFxuICAgICAgICAkKGAuJHtjb2RlYmFzZUlkVG9BZGRDbGFzc31gKS5yZW1vdmVDbGFzcyhURU1QT1JBUllfU1RZTElOR19DTEFTU19OQU1FKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNzc0VxdWl2YWxlbnQpIHtcbiAgICAgICAgaWYgKG1vZGlmaWVycyAmJiBtb2RpZmllcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IENTU19QU0VVRE9fTU9ESUZJRVJTID0gW1xuICAgICAgICAgICAgJ2hvdmVyJyxcbiAgICAgICAgICAgICdyZXF1aXJlZCcsXG4gICAgICAgICAgICAnZm9jdXMnLFxuICAgICAgICAgICAgJ2FjdGl2ZScsXG4gICAgICAgICAgICAnaW52YWxpZCcsXG4gICAgICAgICAgICAnZGlzYWJsZWQnLFxuICAgICAgICAgIF07XG5cbiAgICAgICAgICBjb25zdCBwc2V1ZG9Nb2RpZmllcnMgPSBtb2RpZmllcnMuZmlsdGVyKChtb2RpZmllcikgPT5cbiAgICAgICAgICAgIENTU19QU0VVRE9fTU9ESUZJRVJTLmluY2x1ZGVzKG1vZGlmaWVyKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHBzZXVkb01vZGlmaWVyc1N1ZmZpeCA9IHBzZXVkb01vZGlmaWVycy5qb2luKCc6Jyk7XG5cbiAgICAgICAgICBpZiAocHNldWRvTW9kaWZpZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IG1vZGlmaWVyQ2xhc3MgPSBgJHtjbGFzc1RvQWRkfToke3BzZXVkb01vZGlmaWVyc1N1ZmZpeH1gO1xuICAgICAgICAgICAgYWRkQ2xhc3NDc3NSdWxlKG1vZGlmaWVyQ2xhc3MsIGNzc0VxdWl2YWxlbnQsIG1vZGlmaWVyQ2xhc3MpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhZGRDbGFzc0Nzc1J1bGUoY2xhc3NUb0FkZCwgY3NzRXF1aXZhbGVudCwgY2xhc3NUb0FkZCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgZm9yY2VDbGFzc2VzID0gbW9kaWZpZXJzXG4gICAgICAgICAgICAubWFwKChtb2RpZmllcikgPT4gYC50ZW1wby1mb3JjZS0ke21vZGlmaWVyfWApXG4gICAgICAgICAgICAuam9pbignJyk7XG4gICAgICAgICAgY29uc3QgaW5zdGFudFVwZGF0ZUZvckZvcmNlQ2xhc3MgPSBgJHtjbGFzc1RvQWRkfSR7Zm9yY2VDbGFzc2VzfWA7XG5cbiAgICAgICAgICBhZGRDbGFzc0Nzc1J1bGUoXG4gICAgICAgICAgICBpbnN0YW50VXBkYXRlRm9yRm9yY2VDbGFzcyxcbiAgICAgICAgICAgIGNzc0VxdWl2YWxlbnQsXG4gICAgICAgICAgICBpbnN0YW50VXBkYXRlRm9yRm9yY2VDbGFzcyxcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFkZENsYXNzQ3NzUnVsZShjbGFzc1RvQWRkLCBjc3NFcXVpdmFsZW50LCBjbGFzc1RvQWRkKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBjdXJyZW50QWRkQ2xhc3NWYWx1ZXMgPVxuICAgICAgICBnZXRNZW1vcnlTdG9yYWdlSXRlbShBRERfQ0xBU1NfSU5TVEFOVF9VUERBVEVfUVVFVUUpIHx8IFtdO1xuXG4gICAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgICAgaWYgKCQoYC4ke2NvZGViYXNlSWRUb0FkZENsYXNzfWApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgJChgLiR7Y29kZWJhc2VJZFRvQWRkQ2xhc3N9YCkuYWRkQ2xhc3MoY2xhc3NUb0FkZCk7XG5cbiAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuXG4gICAgICAgIGN1cnJlbnRBZGRDbGFzc1ZhbHVlcy5wdXNoKHtcbiAgICAgICAgICBjb2RlYmFzZUlkOiBjb2RlYmFzZUlkVG9BZGRDbGFzcyxcbiAgICAgICAgICBjbGFzc05hbWU6IGNsYXNzVG9BZGQsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVHJ5IHRvIGZpbmQgaXQgYnkgdGhlIGNvbXBvbmVudCBJRFxuICAgICAgICBsZXQgdG9wTGV2ZWxDb2RlYmFzZUlkID0gZ2V0VG9wTGV2ZWxDb2RlYmFzZUlkRm9yQ29tcG9uZW50KFxuICAgICAgICAgIGNvZGViYXNlSWRUb0FkZENsYXNzIHx8ICcnLFxuICAgICAgICApO1xuXG4gICAgICAgIGlmICh0b3BMZXZlbENvZGViYXNlSWQgJiYgJChgLiR7dG9wTGV2ZWxDb2RlYmFzZUlkfWApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgICAgICAgJChgLiR7dG9wTGV2ZWxDb2RlYmFzZUlkfWApLmFkZENsYXNzKGNsYXNzVG9BZGQpO1xuXG4gICAgICAgICAgY3VycmVudEFkZENsYXNzVmFsdWVzLnB1c2goe1xuICAgICAgICAgICAgY29kZWJhc2VJZDogdG9wTGV2ZWxDb2RlYmFzZUlkLFxuICAgICAgICAgICAgY2xhc3NOYW1lOiBjbGFzc1RvQWRkLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHNldE1lbW9yeVN0b3JhZ2VJdGVtKFxuICAgICAgICBBRERfQ0xBU1NfSU5TVEFOVF9VUERBVEVfUVVFVUUsXG4gICAgICAgIGN1cnJlbnRBZGRDbGFzc1ZhbHVlcyxcbiAgICAgICk7XG5cbiAgICAgIGV4dHJhSW5zdGFudFVwZGF0ZURhdGEuYWRkZWRDbGFzcyA9IGNsYXNzVG9BZGQ7XG4gICAgICBleHRyYUluc3RhbnRVcGRhdGVEYXRhLmNvZGViYXNlQWRkZWRDbGFzcyA9IGNvZGViYXNlQ2xhc3NOYW1lO1xuICAgIH1cbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuUkVNT1ZFX0NMQVNTKSB7XG4gICAgY29uc3QgcmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHMgPVxuICAgICAgY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgUmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHM7XG5cbiAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgIGlmICgkKGAuJHtyZW1vdmVDbGFzc0NoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9SZW1vdmVDbGFzc31gKS5sZW5ndGggPiAwKSB7XG4gICAgICAkKGAuJHtyZW1vdmVDbGFzc0NoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9SZW1vdmVDbGFzc31gKS5yZW1vdmVDbGFzcyhcbiAgICAgICAgcmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHMuY2xhc3NOYW1lLFxuICAgICAgKTtcblxuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUcnkgdG8gZmluZCBpdCBieSB0aGUgY29tcG9uZW50IElEXG4gICAgICBsZXQgdG9wTGV2ZWxDb2RlYmFzZUlkID0gZ2V0VG9wTGV2ZWxDb2RlYmFzZUlkRm9yQ29tcG9uZW50KFxuICAgICAgICByZW1vdmVDbGFzc0NoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9SZW1vdmVDbGFzcyB8fCAnJyxcbiAgICAgICk7XG5cbiAgICAgIGlmICh0b3BMZXZlbENvZGViYXNlSWQgJiYgJChgLiR7dG9wTGV2ZWxDb2RlYmFzZUlkfWApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICAkKGAuJHt0b3BMZXZlbENvZGViYXNlSWR9YCkucmVtb3ZlQ2xhc3MoXG4gICAgICAgICAgcmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHMuY2xhc3NOYW1lLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuV1JBUF9ESVYpIHtcbiAgICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBXcmFwRGl2Q2hhbmdlRmllbGRzO1xuICAgIGNvbnN0IGNvZGViYXNlSWRzVG9XcmFwID0gY2hhbmdlRmllbGRzLmNvZGViYXNlSWRzVG9XcmFwO1xuXG4gICAgY29uc3QgZmlyc3RDb2RlYmFzZUlkID0gY29kZWJhc2VJZHNUb1dyYXBbMF07XG5cbiAgICAvLyBXZSBhc3N1bWUgdGhlIG90aGVyIGNvZGViYXNlIElEcyBhcmUgc2libGluZ3Mgb2YgdGhpcyBjb2RlYmFzZSBJRCwgc28gd2VcbiAgICAvLyBmaW5kIGVhY2ggaW5zdGFuY2Ugb2YgdGhlIGZpcnN0IG9uZSBhbmQgaW5jbHVkZSB0aGUgb3RoZXIgaXRlbXMgdGhhdCBtYXRjaCBpbiBpdFxuICAgIC8vIElmIHRoZSBvdGhlciBpdGVtcyBhcmVuJ3QgYWxsIGZvdW5kLCB3ZSBkbyBub3Qgd3JhcCBhbmQgbGV0IGhvdCByZWxvYWQgaGFuZGxlIGl0XG4gICAgJChgLiR7Zmlyc3RDb2RlYmFzZUlkfWApLmVhY2goKGluZGV4OiBhbnksIGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IG90aGVyQ29kZWJhc2VJZHMgPSBjb2RlYmFzZUlkc1RvV3JhcC5zbGljZSgxKTtcbiAgICAgIC8vIEZvciBlYWNoIGNvZGViYXNlIElEIGluIG90aGVyQ29kZWJhc2VJZHMsIHJldHJpZXZlIHRoZSBlbGVtZW50IHRoYXQgaXMgYSBzaWJsaW5nIG9mIGl0ZW1cbiAgICAgIGNvbnN0IHNpYmxpbmdzID0gJChpdGVtKS5zaWJsaW5ncygpO1xuICAgICAgY29uc3QgYWxsSXRlbXNUb0FkZFRvTmV3RGl2ID0gW2l0ZW1dO1xuXG4gICAgICBsZXQgZWFybGllc3RJdGVtID0gaXRlbTtcbiAgICAgIGxldCBlYXJsaWVzdEluZGV4ID0gJChpdGVtKS5pbmRleCgpO1xuXG4gICAgICBvdGhlckNvZGViYXNlSWRzLmZvckVhY2goKGNvZGViYXNlSWQpID0+IHtcbiAgICAgICAgY29uc3QgZm91bmRTaWJsaW5nID0gc2libGluZ3MuZmlsdGVyKGAuJHtjb2RlYmFzZUlkfWApLmdldCgwKTtcbiAgICAgICAgaWYgKGZvdW5kU2libGluZykge1xuICAgICAgICAgIGFsbEl0ZW1zVG9BZGRUb05ld0Rpdi5wdXNoKGZvdW5kU2libGluZyk7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSAkKGZvdW5kU2libGluZykuaW5kZXgoKTtcbiAgICAgICAgICBpZiAoaW5kZXggPCBlYXJsaWVzdEluZGV4KSB7XG4gICAgICAgICAgICBlYXJsaWVzdEl0ZW0gPSBmb3VuZFNpYmxpbmc7XG4gICAgICAgICAgICBlYXJsaWVzdEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gVE9ETzogV2hhdCB0byBkbyBpZiB0aGV5IGFsbCBjYW4ndCBiZSBmb3VuZD9cbiAgICAgIGlmIChhbGxJdGVtc1RvQWRkVG9OZXdEaXYubGVuZ3RoICE9PSBjb2RlYmFzZUlkc1RvV3JhcC5sZW5ndGgpIHtcbiAgICAgICAgLy8gRm9yIG5vdywganVzdCBhZGQgdGhlIG9uZXMgdGhhdCB3ZXJlIGZvdW5kXG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBhIGRpdiB3aXRoIGEgY2xvbmUgb2YgdGhlIGl0ZW0sIHdoaWxlIGhpZGluZyB0aGUgaXRlbVxuICAgICAgLy8gV2hlbiB0aGUgaG90IHJlbG9hZCBoYXBwZW5zIHRoZSBjbG9uZSBnZXRzIGRlbGV0ZWQgYW5kIHRoZSBpdGVtIGlzIHNob3duIGFnYWluXG4gICAgICBjb25zdCBuZXdEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIG5ld0Rpdi5jbGFzc05hbWUgPSBXUkFQX0lOX0RJVl9QTEFDRUhPTERFUl9DT0RFQkFTRV9JRDtcbiAgICAgIG5ld0Rpdi5zZXRBdHRyaWJ1dGUoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7IC8vIFNvIHRoYXQgdGhlIERPTSB0cmVlIHJlZnJlc2ggZG9lc24ndCBnZXQgdHJpZ2dlcmVkXG4gICAgICBuZXdEaXYuc2V0QXR0cmlidXRlKFxuICAgICAgICAndGVtcG9lbGVtZW50aWQnLFxuICAgICAgICBXUkFQX0lOX0RJVl9QTEFDRUhPTERFUl9DT0RFQkFTRV9JRCxcbiAgICAgICk7XG4gICAgICBuZXdEaXYuc2V0QXR0cmlidXRlKCdkYXRhLXRlc3RpZCcsIFdSQVBfSU5fRElWX1BMQUNFSE9MREVSX0NPREVCQVNFX0lEKTtcbiAgICAgIG5ld0Rpdi5zZXRBdHRyaWJ1dGUoVEVNUE9fREVMRVRFX0FGVEVSX1JFRlJFU0gsICd0cnVlJyk7XG4gICAgICBhbGxJdGVtc1RvQWRkVG9OZXdEaXYuZm9yRWFjaCgoZWxlbSkgPT4ge1xuICAgICAgICBuZXdEaXYuYXBwZW5kQ2hpbGQoZWxlbS5jbG9uZU5vZGUodHJ1ZSkpO1xuXG4gICAgICAgIGVsZW0uY2xhc3NMaXN0LmFkZChURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyk7XG4gICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKFRFTVBPX0RPX05PVF9TSE9XX0lOX05BVl9VTlRJTF9SRUZSRVNILCAndHJ1ZScpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIEluc2VydCB0aGUgbmV3IGRpdiByaWdodCBiZWZvcmUgdGhlIGZpcnN0IGl0ZW1cbiAgICAgIGVhcmxpZXN0SXRlbS5pbnNlcnRBZGphY2VudEVsZW1lbnQoJ2JlZm9yZWJlZ2luJywgbmV3RGl2KTtcblxuICAgICAgc2VuZE5ld05hdlRyZWUgPSB0cnVlO1xuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5EVVBMSUNBVEUpIHtcbiAgICBjb25zdCBjaGFuZ2VGaWxlZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBEdXBsaWNhdGVDaGFuZ2VGaWVsZHM7XG4gICAgY29uc3QgY29kZWJhc2VJZHNUb0R1cGxpY2F0ZSA9IGNoYW5nZUZpbGVkcy5jb2RlYmFzZUlkc1RvRHVwbGljYXRlO1xuXG4gICAgY29kZWJhc2VJZHNUb0R1cGxpY2F0ZS5mb3JFYWNoKChjb2RlYmFzZUlkVG9EdXBsaWNhdGUpID0+IHtcbiAgICAgICQoYC4ke2NvZGViYXNlSWRUb0R1cGxpY2F0ZX1gKS5lYWNoKChpbmRleDogYW55LCBpdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsb25lZE5vZGUgPSBpdGVtLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudDtcblxuICAgICAgICBjbG9uZWROb2RlLnNldEF0dHJpYnV0ZShURU1QT19ERUxFVEVfQUZURVJfUkVGUkVTSCwgJ3RydWUnKTtcbiAgICAgICAgY2xvbmVkTm9kZS5zZXRBdHRyaWJ1dGUoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7IC8vIFNvIHRoYXQgdGhlIERPTSB0cmVlIHJlZnJlc2ggZG9lc24ndCBnZXQgdHJpZ2dlcmVkXG5cbiAgICAgICAgLy8gU2V0IHVwIGFsbCB0aGUgY29ycmVjdCBkdXBsaWNhdGVkIGNvZGViYXNlIElEc1xuICAgICAgICBjbG9uZWROb2RlLnNldEF0dHJpYnV0ZShcbiAgICAgICAgICAndGVtcG9lbGVtZW50aWQnLFxuICAgICAgICAgIGAke0RVUExJQ0FURV9QTEFDRUhPTERFUl9QUkVGSVh9JHtjb2RlYmFzZUlkVG9EdXBsaWNhdGV9YCxcbiAgICAgICAgKTtcbiAgICAgICAgY2xvbmVkTm9kZS5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgJ2RhdGEtdGVzdGlkJyxcbiAgICAgICAgICBgJHtEVVBMSUNBVEVfUExBQ0VIT0xERVJfUFJFRklYfSR7Y29kZWJhc2VJZFRvRHVwbGljYXRlfWAsXG4gICAgICAgICk7XG4gICAgICAgIGNsb25lZE5vZGUuY2xhc3NMaXN0LmFkZChcbiAgICAgICAgICBEVVBMSUNBVEVfUExBQ0VIT0xERVJfUFJFRklYICsgY29kZWJhc2VJZFRvRHVwbGljYXRlLFxuICAgICAgICApO1xuICAgICAgICBjbG9uZWROb2RlLmNsYXNzTGlzdC5yZW1vdmUoY29kZWJhc2VJZFRvRHVwbGljYXRlKTtcblxuICAgICAgICBsZXQgY2hpbGRyZW4gPSBBcnJheS5mcm9tKGNsb25lZE5vZGUuY2hpbGRyZW4pO1xuICAgICAgICB3aGlsZSAoY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbi5wb3AoKTtcbiAgICAgICAgICBpZiAoIWNoaWxkKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBjb2RlYmFzZUlkID1cbiAgICAgICAgICAgIGNoaWxkLmdldEF0dHJpYnV0ZSgndGVtcG9lbGVtZW50aWQnKSB8fFxuICAgICAgICAgICAgY2hpbGQuZ2V0QXR0cmlidXRlKCdkYXRhLXRlc3RpZCcpO1xuICAgICAgICAgIGlmICghY29kZWJhc2VJZCkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY2hpbGQuc2V0QXR0cmlidXRlKFxuICAgICAgICAgICAgJ3RlbXBvZWxlbWVudGlkJyxcbiAgICAgICAgICAgIGAke0RVUExJQ0FURV9QTEFDRUhPTERFUl9QUkVGSVh9JHtjb2RlYmFzZUlkfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjaGlsZC5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgICAnZGF0YS10ZXN0aWQnLFxuICAgICAgICAgICAgYCR7RFVQTElDQVRFX1BMQUNFSE9MREVSX1BSRUZJWH0ke2NvZGViYXNlSWR9YCxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNoaWxkLmNsYXNzTGlzdC5yZW1vdmUoY29kZWJhc2VJZCk7XG4gICAgICAgICAgY2hpbGQuY2xhc3NMaXN0LmFkZChEVVBMSUNBVEVfUExBQ0VIT0xERVJfUFJFRklYICsgY29kZWJhc2VJZCk7XG4gICAgICAgICAgY2hpbGQuc2V0QXR0cmlidXRlKFRFTVBPX0lOU1RBTlRfVVBEQVRFLCAndHJ1ZScpO1xuXG4gICAgICAgICAgY2hpbGRyZW4ucHVzaCguLi5BcnJheS5mcm9tKGNoaWxkLmNoaWxkcmVuKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBZGQgdGhlIGNsb25lcyBub2RlIHJpZ2h0IGFmdGVyIHRoZSBmb3VuZCBub2RlXG4gICAgICAgIGl0ZW0uaW5zZXJ0QWRqYWNlbnRFbGVtZW50KCdhZnRlcmVuZCcsIGNsb25lZE5vZGUpO1xuXG4gICAgICAgIHNlbmROZXdOYXZUcmVlID0gdHJ1ZTtcbiAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLkNIQU5HRV9UQUcpIHtcbiAgICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBDaGFuZ2VUYWdDaGFuZ2VGaWVsZHM7XG5cbiAgICAkKGAuJHtjaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQ2hhbmdlfWApLmVhY2goKGluZGV4OiBhbnksIGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0ICRuZXdFbGVtZW50ID0gJChcbiAgICAgICAgJzwnICsgY2hhbmdlRmllbGRzLm5ld1RhZ05hbWUgKyAnPjwvJyArIGNoYW5nZUZpZWxkcy5uZXdUYWdOYW1lICsgJz4nLFxuICAgICAgKTtcbiAgICAgICRuZXdFbGVtZW50LmF0dHIoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7IC8vIFNvIHRoYXQgdGhlIERPTSB0cmVlIHJlZnJlc2ggZG9lc24ndCBnZXQgdHJpZ2dlcmVkXG4gICAgICAkbmV3RWxlbWVudC5hdHRyKFRFTVBPX0RFTEVURV9BRlRFUl9SRUZSRVNILCAndHJ1ZScpO1xuXG4gICAgICBjb25zdCAkaXRlbSA9ICQoaXRlbSk7XG5cbiAgICAgIC8vIENvcHkgYWxsIGF0dHJpYnV0ZXMgZnJvbSB0aGUgb3JpZ2luYWwgZWxlbWVudCB0byB0aGUgbmV3IGVsZW1lbnRcbiAgICAgICQuZWFjaCgkaXRlbVswXS5hdHRyaWJ1dGVzLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICRuZXdFbGVtZW50LmF0dHIodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTtcbiAgICAgIH0pO1xuXG4gICAgICAkaXRlbS5jb250ZW50cygpLmNsb25lKHRydWUsIHRydWUpLmFwcGVuZFRvKCRuZXdFbGVtZW50KTtcblxuICAgICAgLy8gQWRkIHJpZ2h0IGJlZm9yZSB0aGUgY2xvbmVkIGl0ZW0gc28gdGhlIHVuaXF1ZSBwYXRoIHN0YXlzIHRoZSBzYW1lXG4gICAgICAkaXRlbS5iZWZvcmUoJG5ld0VsZW1lbnQpO1xuXG4gICAgICAvLyBIaWRlIHRoZSBvcmlnaW5hbCBpdGVtXG4gICAgICAkaXRlbS5hZGRDbGFzcyhURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyk7XG4gICAgICAkaXRlbS5hdHRyKFRFTVBPX0RPX05PVF9TSE9XX0lOX05BVl9VTlRJTF9SRUZSRVNILCAndHJ1ZScpO1xuXG4gICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLlVORE8pIHtcbiAgICBjb25zdCB7XG4gICAgICBzZW5kTmV3TmF2VHJlZTogX3NlbmROZXdOYXZUcmVlLFxuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWw6IF9pbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCxcbiAgICB9ID0gYXBwbHlVbmRvQ2hhbmdlSXRlbVRvRG9jdW1lbnQocGFyZW50UG9ydCwgY2hhbmdlSXRlbSBhcyBVbmRvQ2hhbmdlKTtcblxuICAgIHNlbmROZXdOYXZUcmVlID0gX3NlbmROZXdOYXZUcmVlO1xuICAgIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gX2luc3RhbnRVcGRhdGVTdWNjZXNzZnVsO1xuICB9IGVsc2UgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5SRURPKSB7XG4gICAgY29uc3QgY2hhbmdlRmllbGRzID0gY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgUmVkb0NoYW5nZUZpZWxkcztcblxuICAgIGNvbnN0IGNoYW5nZVRvUmVkbyA9IGNoYW5nZUZpZWxkcy5jaGFuZ2VUb1JlZG87XG5cbiAgICBpZiAoQ0hBTkdFX1RZUEVTX1dJVEhfSU5TVEFOVF9VTkRPLmluY2x1ZGVzKGNoYW5nZVRvUmVkby50eXBlKSkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBzZW5kTmV3TmF2VHJlZTogX3NlbmROZXdOYXZUcmVlLFxuICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bDogX2luc3RhbnRVcGRhdGVTdWNjZXNzZnVsLFxuICAgICAgfSA9IGFwcGx5Q2hhbmdlSXRlbVRvRG9jdW1lbnQocGFyZW50UG9ydCwgc3Rvcnlib2FyZElkLCBjaGFuZ2VUb1JlZG8pO1xuXG4gICAgICBzZW5kTmV3TmF2VHJlZSA9IF9zZW5kTmV3TmF2VHJlZTtcbiAgICAgIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gX2luc3RhbnRVcGRhdGVTdWNjZXNzZnVsO1xuXG4gICAgICBpZiAoY2hhbmdlVG9SZWRvLnByZXZJZFRvTmV3SWRNYXApIHtcbiAgICAgICAgY29uc3Qgc2VuZE5ld0Zyb21VcGRhdGUgPSB1cGRhdGVDb2RlYmFzZUlkcyhcbiAgICAgICAgICBwYXJlbnRQb3J0LFxuICAgICAgICAgIGNoYW5nZVRvUmVkby5wcmV2SWRUb05ld0lkTWFwLFxuICAgICAgICAgIHRydWUsXG4gICAgICAgICk7XG4gICAgICAgIHNlbmROZXdOYXZUcmVlID0gc2VuZE5ld0Zyb21VcGRhdGUgfHwgc2VuZE5ld05hdlRyZWU7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2UgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5VUERBVEVfQ0xBU1NFUykge1xuICAgIGNvbnN0IHtcbiAgICAgIGNvZGViYXNlSWRUb1VwZGF0ZUNsYXNzLFxuICAgICAgbmV3Q2xhc3NlcyxcbiAgICAgIG9sZENsYXNzZXMsXG4gICAgICBpbnZvbHZlZENsYXNzZXMsXG4gICAgICBpc0luc3RhbnRDaGFuZ2VPbmx5LFxuICAgIH0gPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBVcGRhdGVDbGFzc2VzQ2hhbmdlRmllbGRzO1xuXG4gICAgLy8gVE9ETyhuaGFudGhhaSk6IFNob3VsZCBoYW5kbGUgdGhpcyBiZXR0ZXIgaW5zdGVhZCBvZiBqdXN0IHJlbW92ZSBhbmQgYWRkXG4gICAgZm9yIChjb25zdCBvbGRDbGFzcyBvZiBvbGRDbGFzc2VzKSB7XG4gICAgICAkKGAuJHtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc31gKS5yZW1vdmVDbGFzcyhvbGRDbGFzcyk7XG4gICAgfVxuXG4gICAgKFxuICAgICAgaW50ZXJtZWRpYXRlQ2xhc3Nlc0ZvclNsaWRlckluc3RhbnRVcGRhdGVbY29kZWJhc2VJZFRvVXBkYXRlQ2xhc3NdIHx8IFtdXG4gICAgKS5mb3JFYWNoKChjbGFzc05hbWUpID0+IHtcbiAgICAgICQoYC4ke2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzfWApLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7XG4gICAgfSk7XG5cbiAgICBmb3IgKGNvbnN0IG5ld0NsYXNzIG9mIG5ld0NsYXNzZXMpIHtcbiAgICAgICQoYC4ke2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzfWApLmFkZENsYXNzKG5ld0NsYXNzKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGludm9sdmVkQ2xhc3Mgb2YgaW52b2x2ZWRDbGFzc2VzKSB7XG4gICAgICBhZGRDbGFzc0Nzc1J1bGUoXG4gICAgICAgIGludm9sdmVkQ2xhc3MudGFpbHdpbmQsXG4gICAgICAgIGludm9sdmVkQ2xhc3MuY3NzLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIGludm9sdmVkQ2xhc3MudmFyaWFudCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGlzSW5zdGFudENoYW5nZU9ubHkpIHtcbiAgICAgIGludGVybWVkaWF0ZUNsYXNzZXNGb3JTbGlkZXJJbnN0YW50VXBkYXRlW2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzXSA9IFtdO1xuICAgICAgZm9yIChjb25zdCBpbnZvbHZlZENsYXNzIG9mIGludm9sdmVkQ2xhc3Nlcykge1xuICAgICAgICBjb25zdCBjbGFzc1RvU2V0ID0gaW52b2x2ZWRDbGFzcy52YXJpYW50XG4gICAgICAgICAgPyBgJHtpbnZvbHZlZENsYXNzLnZhcmlhbnR9OiR7aW52b2x2ZWRDbGFzcy50YWlsd2luZH1gXG4gICAgICAgICAgOiBpbnZvbHZlZENsYXNzLnRhaWx3aW5kO1xuICAgICAgICBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZVtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc10ucHVzaChcbiAgICAgICAgICBjbGFzc1RvU2V0LFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZVtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc10gPSBbXTtcbiAgICB9XG4gIH1cblxuICAvLyBJbW1lZGlhdGVseSBzZXQgdGhlIG5ldyBzZWxlY3RlZCBlbGVtZW50IGtleXMgdG8gcHJldmVudCBhbnkgZGVsYXkgaW4gdGhlIG91dGxpbmVzIHVwZGF0aW5nXG4gIGxldCBlbGVtZW50S2V5VG9TZWxlY3RBZnRlckluc3RhbnRVcGRhdGUgPVxuICAgIGNoYW5nZUl0ZW0uZ2V0RWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlKCk7XG4gIGxldCBlbGVtZW50S2V5c1RvTXVsdGlzZWxlY3RBZnRlckluc3RhbnRVcGRhdGUgPVxuICAgIGNoYW5nZUl0ZW0uZ2V0RWxlbWVudEtleXNUb011bHRpc2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlKCk7XG5cbiAgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5VTkRPKSB7XG4gICAgZWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlID0gKFxuICAgICAgY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgVW5kb0NoYW5nZUZpZWxkc1xuICAgICkuY2hhbmdlVG9VbmRvLmdldEVsZW1lbnRLZXlUb1NlbGVjdEFmdGVyVW5kb0luc3RhbnRVcGRhdGUoKTtcbiAgICBlbGVtZW50S2V5c1RvTXVsdGlzZWxlY3RBZnRlckluc3RhbnRVcGRhdGUgPSAoXG4gICAgICBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBVbmRvQ2hhbmdlRmllbGRzXG4gICAgKS5jaGFuZ2VUb1VuZG8uZ2V0RWxlbWVudEtleXNUb011bHRpc2VsZWN0QWZ0ZXJVbmRvSW5zdGFudFVwZGF0ZSgpO1xuICB9XG5cbiAgaWYgKGVsZW1lbnRLZXlUb1NlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgc2V0TWVtb3J5U3RvcmFnZUl0ZW0oXG4gICAgICBTRUxFQ1RFRF9FTEVNRU5UX0tFWSxcbiAgICAgIGVsZW1lbnRLZXlUb1NlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSxcbiAgICApO1xuICAgIHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuICAgICAgaWQ6IEZJWEVEX0lGUkFNRV9NRVNTQUdFX0lEUy5TRUxFQ1RFRF9FTEVNRU5UX0tFWSxcbiAgICAgIGVsZW1lbnRLZXk6IGVsZW1lbnRLZXlUb1NlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSxcbiAgICAgIG91dGVySFRNTDogZ2V0RnVsbEh0bWxXaXRoRWxlbWVudChbZWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlXSksXG4gICAgfSk7XG4gIH1cblxuICBpZiAoZWxlbWVudEtleXNUb011bHRpc2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICBzZXRNZW1vcnlTdG9yYWdlSXRlbShcbiAgICAgIE1VTFRJX1NFTEVDVEVEX0VMRU1FTlRfS0VZUyxcbiAgICAgIGVsZW1lbnRLZXlzVG9NdWx0aXNlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSxcbiAgICApO1xuICAgIHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuICAgICAgaWQ6IEZJWEVEX0lGUkFNRV9NRVNTQUdFX0lEUy5NVUxUSV9TRUxFQ1RFRF9FTEVNRU5UX0tFWVMsXG4gICAgICBlbGVtZW50S2V5czogZWxlbWVudEtleXNUb011bHRpc2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlLFxuICAgICAgb3V0ZXJIVE1MczogZ2V0RnVsbEh0bWxXaXRoRWxlbWVudChcbiAgICAgICAgZWxlbWVudEtleXNUb011bHRpc2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlIHx8IFtdLFxuICAgICAgKSxcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCkge1xuICAgIC8vIERlbGV0ZSBhbnkgZWxlbWVudHMgdGhhdCBuZWVkIHRvIGJlIGRlbGV0ZWQgYWZ0ZXIgaW5zdGFudCB1cGRhdGVzXG4gICAgJChgKlske1RFTVBPX0RFTEVURV9BRlRFUl9JTlNUQU5UX1VQREFURX09dHJ1ZV1gKS5yZW1vdmUoKTtcbiAgfVxuXG4gIHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuICAgIGlkOiBGSVhFRF9JRlJBTUVfTUVTU0FHRV9JRFMuSU5TVEFOVF9VUERBVEVfRE9ORSxcbiAgICBjaGFuZ2VJdGVtOiBwbGFpbkNoYW5nZUl0ZW0sXG4gICAgaW5zdGFudFVwZGF0ZURhdGE6IGV4dHJhSW5zdGFudFVwZGF0ZURhdGEsXG4gICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwsXG4gIH0pO1xuXG4gIHJldHVybiB7IHNlbmROZXdOYXZUcmVlLCBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCB9O1xufTtcblxuY29uc3QgYXBwbHlVbmRvQ2hhbmdlSXRlbVRvRG9jdW1lbnQgPSAoXG4gIHBhcmVudFBvcnQ6IGFueSxcbiAgY2hhbmdlSXRlbTogVW5kb0NoYW5nZSxcbik6IHsgc2VuZE5ld05hdlRyZWU6IGJvb2xlYW47IGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsOiBib29sZWFuIH0gPT4ge1xuICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcztcblxuICBjb25zdCBjaGFuZ2VUb1VuZG8gPSBjaGFuZ2VGaWVsZHMuY2hhbmdlVG9VbmRvO1xuXG4gIGlmICghQ0hBTkdFX1RZUEVTX1dJVEhfSU5TVEFOVF9VTkRPLmluY2x1ZGVzKGNoYW5nZVRvVW5kby50eXBlKSkge1xuICAgIHJldHVybiB7IHNlbmROZXdOYXZUcmVlOiBmYWxzZSwgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWw6IGZhbHNlIH07XG4gIH1cblxuICBsZXQgc2VuZE5ld05hdlRyZWUgPSBmYWxzZTtcbiAgbGV0IGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gZmFsc2U7XG5cbiAgLy8gQVBJIGhhcyBjb21wbGV0ZWQgYW5kIHRoZSBJRHMgaGF2ZSBiZWVuIHVwZGF0ZWQsIHJldmVyc2UgdGhpcyBjaGFuZ2VcbiAgaWYgKGNoYW5nZVRvVW5kby5wcmV2SWRUb05ld0lkTWFwKSB7XG4gICAgY29uc3QgdW5kb0NvZGViYXNlSWRDaGFuZ2VzOiB7XG4gICAgICBbbmV3Q29kZWJhc2VJZDogc3RyaW5nXTogc3RyaW5nO1xuICAgIH0gPSB7fTtcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VUb1VuZG8ucHJldklkVG9OZXdJZE1hcCkuZm9yRWFjaCgocHJldklkKSA9PiB7XG4gICAgICBjb25zdCBuZXdJZCA9IGNoYW5nZVRvVW5kby5wcmV2SWRUb05ld0lkTWFwW3ByZXZJZF07XG4gICAgICB1bmRvQ29kZWJhc2VJZENoYW5nZXNbbmV3SWRdID0gcHJldklkO1xuICAgIH0pO1xuXG4gICAgLy8gSWYgdW5kb2luZyBkbyBub3QgdXBkYXRlIHRoZSBjb2RlYmFzZSBJRHMgYmFja3dhcmRzIGlmIHRoZXJlIGFyZSBjb2RlYmFzZSBJRHMgdG8gc2V0IGFmdGVyXG4gICAgLy8gdGhlIHVuZG8gaW5zdGFudCB1cGRhdGUgaXMgZG9uZVxuICAgIGNvbnN0IHNlbGVjdGVkRWxlbWVudFNwZWNpZmllZEFmdGVyVW5kbyA9XG4gICAgICBjaGFuZ2VUb1VuZG8uZ2V0RWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJVbmRvSW5zdGFudFVwZGF0ZSgpICE9PSB1bmRlZmluZWQ7XG4gICAgc2VuZE5ld05hdlRyZWUgPSB1cGRhdGVDb2RlYmFzZUlkcyhcbiAgICAgIHBhcmVudFBvcnQsXG4gICAgICB1bmRvQ29kZWJhc2VJZENoYW5nZXMsXG4gICAgICAhc2VsZWN0ZWRFbGVtZW50U3BlY2lmaWVkQWZ0ZXJVbmRvLFxuICAgICk7XG4gIH1cblxuICAvLyBUaGVuIHVuZG8gdGhlIGFjdHVhbCBjaGFuZ2VcbiAgaWYgKGNoYW5nZVRvVW5kby50eXBlID09PSBDaGFuZ2VUeXBlLlJFTU9WRV9KU1gpIHtcbiAgICAvLyBSZS1hZGQgdGhlIHJlbW92ZWQgSlNYXG4gICAgY29uc3QgaW5uZXJDaGFuZ2VGaWVsZHMgPVxuICAgICAgY2hhbmdlVG9VbmRvLmNoYW5nZUZpZWxkcyBhcyBSZW1vdmVKc3hDaGFuZ2VGaWVsZHM7XG4gICAgY29uc3QgY29kZWJhc2VJZHNUb1JlYWRkID0gaW5uZXJDaGFuZ2VGaWVsZHMuY29kZWJhc2VJZHNUb1JlbW92ZTtcblxuICAgIC8vIElmIGl0IGhhcyBiZWVuIGZsdXNoZWQsIHJlLWNyZWF0ZSB0aGUgaHRtbCBlbGVtZW50cyBmcm9tIHRoZSBzYXZlZCBpbm5lciBIVE1MXG4gICAgaWYgKGNoYW5nZUZpZWxkcy5tYXRjaGluZ0FjdGl2aXR5Rmx1c2hlZCkge1xuICAgICAgY29uc3QgaW5zdGFudFVwZGF0ZURhdGEgPSBjaGFuZ2VUb1VuZG8uZ2V0SW5zdGFudFVwZGF0ZURhdGEoKTtcbiAgICAgIGNvbnN0IHBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkOiB7XG4gICAgICAgIFtwYXJlbnRFbGVtZW50S2V5OiBzdHJpbmddOiBhbnlbXTtcbiAgICAgIH0gPSBpbnN0YW50VXBkYXRlRGF0YS5wYXJlbnRUb0VsZW1lbnRLZXlzUmVtb3ZlZCB8fCB7fTtcblxuICAgICAgT2JqZWN0LmVudHJpZXMocGFyZW50VG9FbGVtZW50S2V5c1JlbW92ZWQpLmZvckVhY2goXG4gICAgICAgIChbcGFyZW50RWxlbWVudEtleSwgaXRlbXNSZW1vdmVkXSkgPT4ge1xuICAgICAgICAgIC8vIFNvcnQgdGhlIHJlbW92ZWQgZW50cmllcyBpbiBvcmRlciBvZiB1bmlxdWUgcGF0aFxuICAgICAgICAgIGNvbnN0IHNvcnRlZEl0ZW1zUmVtb3ZlZCA9IE9iamVjdC52YWx1ZXMoaXRlbXNSZW1vdmVkKS5zb3J0KFxuICAgICAgICAgICAgKGE6IGFueSwgYjogYW55KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGFFbGVtZW50S2V5ID0gVGVtcG9FbGVtZW50LmZyb21LZXkoYS5lbGVtZW50S2V5UmVtb3ZlZCk7XG4gICAgICAgICAgICAgIGNvbnN0IGJFbGVtZW50S2V5ID0gVGVtcG9FbGVtZW50LmZyb21LZXkoYi5lbGVtZW50S2V5UmVtb3ZlZCk7XG4gICAgICAgICAgICAgIHJldHVybiBhRWxlbWVudEtleS51bmlxdWVQYXRoLmxvY2FsZUNvbXBhcmUoXG4gICAgICAgICAgICAgICAgYkVsZW1lbnRLZXkudW5pcXVlUGF0aCxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIEZpbmQgdGhlIHBhcmVudCBlbGVtZW50XG4gICAgICAgICAgY29uc3QgcGFyZW50RWxlbWVudCA9IGdldE5vZGVGb3JFbGVtZW50S2V5KHBhcmVudEVsZW1lbnRLZXkpO1xuICAgICAgICAgIGlmIChwYXJlbnRFbGVtZW50KSB7XG4gICAgICAgICAgICAvLyBBZGQgdGhlIHJlbW92ZWQgZWxlbWVudHMgYmFjayBpbiBvcmRlclxuICAgICAgICAgICAgc29ydGVkSXRlbXNSZW1vdmVkLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCB7IGVsZW1lbnRLZXlSZW1vdmVkLCBvdXRlckhUTUwgfSA9IGl0ZW07XG5cbiAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IFRlbXBvRWxlbWVudC5mcm9tS2V5KGVsZW1lbnRLZXlSZW1vdmVkKTtcbiAgICAgICAgICAgICAgY29uc3QgaW5kZXhJblBhcmVudCA9IE51bWJlcihlbGVtZW50LnVuaXF1ZVBhdGguc3BsaXQoJy0nKS5wb3AoKSk7XG5cbiAgICAgICAgICAgICAgY29uc3QgbmV3RWxlbWVudEZyb21IdG1sID0gJChvdXRlckhUTUwpLmdldCgwKTtcblxuICAgICAgICAgICAgICAvLyBBZGQgdG8gdGhlIHBhcmVudCBpbiB0aGUgaW5kZXhcbiAgICAgICAgICAgICAgaWYgKG5ld0VsZW1lbnRGcm9tSHRtbCkge1xuICAgICAgICAgICAgICAgIG5ld0VsZW1lbnRGcm9tSHRtbC5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgICAgICAgICBURU1QT19ERUxFVEVfQUZURVJfUkVGUkVTSCxcbiAgICAgICAgICAgICAgICAgICd0cnVlJyxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIG5ld0VsZW1lbnRGcm9tSHRtbC5zZXRBdHRyaWJ1dGUoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7XG4gICAgICAgICAgICAgICAgcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoXG4gICAgICAgICAgICAgICAgICBuZXdFbGVtZW50RnJvbUh0bWwsXG4gICAgICAgICAgICAgICAgICBwYXJlbnRFbGVtZW50LmNoaWxkcmVuW2luZGV4SW5QYXJlbnRdIHx8IG51bGwsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgICAgICAgICAgICAgc2VuZE5ld05hdlRyZWUgPSB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBOb3QgZmx1c2hlZCB5ZXQgc28gY2FuIGp1c3QgcmUtYWRkXG4gICAgICBjb2RlYmFzZUlkc1RvUmVhZGQuZm9yRWFjaCgoY29kZWJhc2VJZFRvUmVhZGQpID0+IHtcbiAgICAgICAgJChgLiR7Y29kZWJhc2VJZFRvUmVhZGR9YCkuZWFjaCgoaW5kZXgsIGl0ZW0pID0+IHtcbiAgICAgICAgICBpdGVtLmNsYXNzTGlzdC5yZW1vdmUoVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MpO1xuICAgICAgICAgIGl0ZW0ucmVtb3ZlQXR0cmlidXRlKFRFTVBPX0RPX05PVF9TSE9XX0lOX05BVl9VTlRJTF9SRUZSRVNIKTtcblxuICAgICAgICAgIHNlbmROZXdOYXZUcmVlID0gdHJ1ZTtcbiAgICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9IGVsc2UgaWYgKFxuICAgIGNoYW5nZVRvVW5kby50eXBlID09PSBDaGFuZ2VUeXBlLkFERF9DTEFTUyB8fFxuICAgIGNoYW5nZVRvVW5kby50eXBlID09PSBDaGFuZ2VUeXBlLlNUWUxJTkdcbiAgKSB7XG4gICAgY29uc3QgaW5zdGFudFVwZGF0ZURhdGEgPSBjaGFuZ2VUb1VuZG8uZ2V0SW5zdGFudFVwZGF0ZURhdGEoKTtcbiAgICBjb25zdCBpbm5lckNoYW5nZUZpZWxkcyA9IGNoYW5nZVRvVW5kby5jaGFuZ2VGaWVsZHMgYXMgQWRkQ2xhc3NDaGFuZ2VGaWVsZHM7XG5cbiAgICBjb25zdCBhZGRlZENsYXNzID0gaW5zdGFudFVwZGF0ZURhdGE/LmFkZGVkQ2xhc3M7XG4gICAgaWYgKGFkZGVkQ2xhc3MpIHtcbiAgICAgICQoYC4ke2lubmVyQ2hhbmdlRmllbGRzLmNvZGViYXNlSWRUb0FkZENsYXNzfWApLmVhY2goKGluZGV4LCBpdGVtKSA9PiB7XG4gICAgICAgIGlmICgkKGl0ZW0pLmhhc0NsYXNzKGFkZGVkQ2xhc3MpKSB7XG4gICAgICAgICAgJChpdGVtKS5yZW1vdmVDbGFzcyhhZGRlZENsYXNzKTtcbiAgICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGNvZGViYXNlQWRkZWRDbGFzcyA9IGluc3RhbnRVcGRhdGVEYXRhPy5jb2RlYmFzZUFkZGVkQ2xhc3M7XG4gICAgaWYgKGNvZGViYXNlQWRkZWRDbGFzcykge1xuICAgICAgJChgLiR7aW5uZXJDaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQWRkQ2xhc3N9YCkuZWFjaCgoaW5kZXgsIGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKCQoaXRlbSkuaGFzQ2xhc3MoY29kZWJhc2VBZGRlZENsYXNzKSkge1xuICAgICAgICAgICQoaXRlbSkucmVtb3ZlQ2xhc3MoY29kZWJhc2VBZGRlZENsYXNzKTtcbiAgICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSBlbHNlIGlmIChjaGFuZ2VUb1VuZG8udHlwZSA9PT0gQ2hhbmdlVHlwZS5VUERBVEVfQ0xBU1NFUykge1xuICAgIGNvbnN0IHsgY29kZWJhc2VJZFRvVXBkYXRlQ2xhc3MsIG5ld0NsYXNzZXMsIG9sZENsYXNzZXMgfSA9XG4gICAgICBjaGFuZ2VUb1VuZG8uY2hhbmdlRmllbGRzIGFzIFVwZGF0ZUNsYXNzZXNDaGFuZ2VGaWVsZHM7XG5cbiAgICAvLyBUT0RPKG5oYW50aGFpKTogU2hvdWxkIGhhbmRsZSB0aGlzIGJldHRlciBpbnN0ZWFkIG9mIGp1c3QgcmVtb3ZlIGFuZCBhZGRcbiAgICBmb3IgKGNvbnN0IG5ld0NsYXNzIG9mIG5ld0NsYXNzZXMpIHtcbiAgICAgICQoYC4ke2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzfWApLnJlbW92ZUNsYXNzKG5ld0NsYXNzKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IG9sZENsYXNzIG9mIG9sZENsYXNzZXMpIHtcbiAgICAgICQoYC4ke2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzfWApLmFkZENsYXNzKG9sZENsYXNzKTtcbiAgICB9XG5cbiAgICBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZVtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc10gPSBbXTtcbiAgfSBlbHNlIGlmIChjaGFuZ2VUb1VuZG8udHlwZSA9PT0gQ2hhbmdlVHlwZS5BRERfSlNYKSB7XG4gICAgY29uc3QgaW5zdGFudFVwZGF0ZURhdGEgPSBjaGFuZ2VUb1VuZG8uZ2V0SW5zdGFudFVwZGF0ZURhdGEoKTtcbiAgICBjb25zdCBhZGRlZElkcyA9IGluc3RhbnRVcGRhdGVEYXRhPy5hZGRlZElkcztcblxuICAgIGFkZGVkSWRzPy5mb3JFYWNoKChhZGRlZElkOiBzdHJpbmcpID0+IHtcbiAgICAgICQoYC4ke2FkZGVkSWR9YCkucmVtb3ZlKCk7XG4gICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgfSk7XG5cbiAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gIH1cblxuICByZXR1cm4geyBzZW5kTmV3TmF2VHJlZSwgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgfTtcbn07XG5cbi8qKlxuICogQWZ0ZXIgYSBjaGFuZ2UgaXMgcHJvY2Vzc2VkIG9uIHRoZSBiYWNrZW5kLCB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgY29kZWJhc2UgaWRzIGluIHRoZSBkb2N1bWVudC5cbiAqL1xuZXhwb3J0IGNvbnN0IHVwZGF0ZUNvZGViYXNlSWRzID0gKFxuICBwYXJlbnRQb3J0OiBhbnksXG4gIHByZXZJZFRvTmV3SWRNYXA6IHtcbiAgICBbcHJldkNvZGViYXNlSWQ6IHN0cmluZ106IHN0cmluZztcbiAgfSxcbiAgdXBkYXRlRWxlbWVudEtleXM/OiBib29sZWFuLFxuKTogYm9vbGVhbiA9PiB7XG4gIC8vIFVwZGF0ZSBjb2RlYmFzZSBpZHMgaW4gdGhlIGRvY3VtZW50XG4gIGNvbnN0IGNoYW5nZXM6IGFueSA9IFtdO1xuICBPYmplY3QuZW50cmllcyhwcmV2SWRUb05ld0lkTWFwKS5mb3JFYWNoKFxuICAgIChbcHJldkNvZGViYXNlSWQsIG5ld0NvZGViYXNlSWRdKSA9PiB7XG4gICAgICAkKGAuJHtwcmV2Q29kZWJhc2VJZH1gKS5lYWNoKChpbmRleDogYW55LCBpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgY2hhbmdlcy5wdXNoKHtcbiAgICAgICAgICBpdGVtLFxuICAgICAgICAgIHByZXZDb2RlYmFzZUlkLFxuICAgICAgICAgIG5ld0NvZGViYXNlSWQsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSxcbiAgKTtcblxuICAvLyBDb2RlYmFzZSBJZHMgY2FuIHN3YXAsIHNvIHdlIGhhdmUgdG8gYXBwbHkgdGhlIGNoYW5nZXMgYWZ0ZXIgbG9va2luZyBhbGwgZWxlbWVudHMgdXBcbiAgY2hhbmdlcy5mb3JFYWNoKChjaGFuZ2U6IGFueSkgPT4ge1xuICAgIGNvbnN0ICRpdGVtID0gJChjaGFuZ2UuaXRlbSk7XG4gICAgY29uc3QgbmV3Q2xhc3MgPSAoJGl0ZW0uYXR0cignY2xhc3MnKSB8fCAnJykucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAoYCR7Y2hhbmdlLnByZXZDb2RlYmFzZUlkfWAsICdnJyksXG4gICAgICBjaGFuZ2UubmV3Q29kZWJhc2VJZCxcbiAgICApO1xuICAgICRpdGVtLmF0dHIoJ2NsYXNzJywgbmV3Q2xhc3MpO1xuXG4gICAgY2hhbmdlLml0ZW0uc2V0QXR0cmlidXRlKCd0ZW1wb2VsZW1lbnRpZCcsIGNoYW5nZS5uZXdDb2RlYmFzZUlkKTtcbiAgICBjaGFuZ2UuaXRlbS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdGVzdGlkJywgY2hhbmdlLm5ld0NvZGViYXNlSWQpO1xuICB9KTtcblxuICBpZiAoIXVwZGF0ZUVsZW1lbnRLZXlzKSB7XG4gICAgcmV0dXJuIEJvb2xlYW4oY2hhbmdlcy5sZW5ndGgpO1xuICB9XG5cbiAgY29uc3Qga2V5c1RvQ2hlY2sgPSBbXG4gICAge1xuICAgICAga2V5OiBTRUxFQ1RFRF9FTEVNRU5UX0tFWSxcbiAgICAgIG1lc3NhZ2VJZDogRklYRURfSUZSQU1FX01FU1NBR0VfSURTLlNFTEVDVEVEX0VMRU1FTlRfS0VZLFxuICAgIH0sXG4gICAge1xuICAgICAga2V5OiBIT1ZFUkVEX0VMRU1FTlRfS0VZLFxuICAgICAgbWVzc2FnZUlkOiBGSVhFRF9JRlJBTUVfTUVTU0FHRV9JRFMuSE9WRVJFRF9FTEVNRU5UX0tFWSxcbiAgICB9LFxuICBdO1xuICBrZXlzVG9DaGVjay5mb3JFYWNoKCh7IGtleSwgbWVzc2FnZUlkIH0pID0+IHtcbiAgICBjb25zdCBlbGVtZW50S2V5ID0gZ2V0TWVtb3J5U3RvcmFnZUl0ZW0oa2V5KTtcbiAgICBjb25zdCB0ZW1wb0VsZW1lbnQgPSBUZW1wb0VsZW1lbnQuZnJvbUtleShlbGVtZW50S2V5KTtcbiAgICBpZiAocHJldklkVG9OZXdJZE1hcFt0ZW1wb0VsZW1lbnQuY29kZWJhc2VJZF0pIHtcbiAgICAgIGNvbnN0IG5ld0VsZW1lbnQgPSBuZXcgVGVtcG9FbGVtZW50KFxuICAgICAgICBwcmV2SWRUb05ld0lkTWFwW3RlbXBvRWxlbWVudC5jb2RlYmFzZUlkXSxcbiAgICAgICAgdGVtcG9FbGVtZW50LnN0b3J5Ym9hcmRJZCxcbiAgICAgICAgdGVtcG9FbGVtZW50LnVuaXF1ZVBhdGgsXG4gICAgICApO1xuICAgICAgc2V0TWVtb3J5U3RvcmFnZUl0ZW0oa2V5LCBuZXdFbGVtZW50LmdldEtleSgpKTtcblxuICAgICAgcGFyZW50UG9ydC5wb3N0TWVzc2FnZSh7XG4gICAgICAgIGlkOiBtZXNzYWdlSWQsXG4gICAgICAgIGVsZW1lbnRLZXk6IG5ld0VsZW1lbnQuZ2V0S2V5KCksXG4gICAgICAgIG91dGVySFRNTDogZ2V0RnVsbEh0bWxXaXRoRWxlbWVudChbbmV3RWxlbWVudC5nZXRLZXkoKV0pLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBBbHNvIHVwZGF0ZSB0aGUgbXVsdGlzZWxlY3RlZCBlbGVtZW50IGtleXNcbiAgY29uc3QgbXVsdGlzZWxlY3RlZEVsZW1lbnRLZXlzID0gZ2V0TWVtb3J5U3RvcmFnZUl0ZW0oXG4gICAgTVVMVElfU0VMRUNURURfRUxFTUVOVF9LRVlTLFxuICApO1xuICBpZiAobXVsdGlzZWxlY3RlZEVsZW1lbnRLZXlzPy5sZW5ndGgpIHtcbiAgICBjb25zdCBuZXdNdWx0aXNlbGVjdGVkRWxlbWVudEtleXM6IHN0cmluZ1tdID0gW107XG4gICAgbXVsdGlzZWxlY3RlZEVsZW1lbnRLZXlzLmZvckVhY2goKGVsZW1lbnRLZXk6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgdGVtcG9FbGVtZW50ID0gVGVtcG9FbGVtZW50LmZyb21LZXkoZWxlbWVudEtleSk7XG4gICAgICBpZiAocHJldklkVG9OZXdJZE1hcFt0ZW1wb0VsZW1lbnQuY29kZWJhc2VJZF0pIHtcbiAgICAgICAgY29uc3QgbmV3RWxlbWVudCA9IG5ldyBUZW1wb0VsZW1lbnQoXG4gICAgICAgICAgcHJldklkVG9OZXdJZE1hcFt0ZW1wb0VsZW1lbnQuY29kZWJhc2VJZF0sXG4gICAgICAgICAgdGVtcG9FbGVtZW50LnN0b3J5Ym9hcmRJZCxcbiAgICAgICAgICB0ZW1wb0VsZW1lbnQudW5pcXVlUGF0aCxcbiAgICAgICAgKTtcbiAgICAgICAgbmV3TXVsdGlzZWxlY3RlZEVsZW1lbnRLZXlzLnB1c2gobmV3RWxlbWVudC5nZXRLZXkoKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdNdWx0aXNlbGVjdGVkRWxlbWVudEtleXMucHVzaChlbGVtZW50S2V5KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHNldE1lbW9yeVN0b3JhZ2VJdGVtKFxuICAgICAgTVVMVElfU0VMRUNURURfRUxFTUVOVF9LRVlTLFxuICAgICAgbmV3TXVsdGlzZWxlY3RlZEVsZW1lbnRLZXlzLFxuICAgICk7XG4gICAgcGFyZW50UG9ydC5wb3N0TWVzc2FnZSh7XG4gICAgICBpZDogRklYRURfSUZSQU1FX01FU1NBR0VfSURTLk1VTFRJX1NFTEVDVEVEX0VMRU1FTlRfS0VZUyxcbiAgICAgIGVsZW1lbnRLZXlzOiBuZXdNdWx0aXNlbGVjdGVkRWxlbWVudEtleXMsXG4gICAgICBvdXRlckhUTUxzOiBnZXRGdWxsSHRtbFdpdGhFbGVtZW50KG5ld011bHRpc2VsZWN0ZWRFbGVtZW50S2V5cyksXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gQm9vbGVhbihjaGFuZ2VzLmxlbmd0aCk7XG59O1xuIl19